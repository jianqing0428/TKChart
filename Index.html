<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<title>仿通达信公式编辑器</title>
    <!-- 加载资源 -->
    <link rel="stylesheet" href="../jscommon/iyxchart.resource/font/iconfont.css" />
    <link rel="stylesheet" href="../jscommon/iyxchart.resource/font/drawtool/iconfont.css" />
    <link rel="stylesheet" href="../jscommon/iyxchart.resource/css/tools.css" />
    <link rel="stylesheet" href="../jscommon/iyxchart.resource/js/codemirror/codemirror.css" />

</head>
<body>

    <!-- 周期切换顶栏 -->
    <div id="PeriodTab">
        <input id="SearchInput" type="text" class="SearchInput" data-i18n="search" placeholder="Symbol / Name" autocomplete="off"/>
        <span id="SearchClear" class="SearchClear">✕</span>
        <div id="MinuteDay" class="TabItem" data-i18n="time">Time</div>
        <div id="Minute5Day" class="TabItem" data-i18n="5d">5D</div>
        <div id="KLineDay" class="TabItem active" data-i18n="1d">1D</div>
        <div id="KLineWeek" class="TabItem" data-i18n="w">W</div>
        <div id="KLineMonth" class="TabItem" data-i18n="m">M</div>
        <div id="KLineYear" class="TabItem" data-i18n="y">Y</div>
        <div id="KLineMinute" class="TabItem" data-i18n="1min">1M</div>
        <div id="KLine5Minute" class="TabItem" data-i18n="5min">5M</div>
        <div id="KLine15Minute" class="TabItem" data-i18n="15min">15M</div>
        <div id="KLine30Minute" class="TabItem" data-i18n="30min">30M</div>

        <div class="SpaceItem"></div>
        <div id="StockChip" class="TabItem" data-i18n="chip">Chip</div>
        <div id="BeforeOpen" class="TabItem" style="display:none;" data-i18n="pre">Pre</div>
        <div id="DrawTool" class="TabItem" data-i18n="draw">Draw</div>
        <div id="btnOpenEditor" class="TabItem" title="Open Indicator Editor">Editor</div>
        <div id="LangBtn" class="TabItem LangBtn" data-i18n="lang">中</div>
        <div id="ThemeBtn" class="TabItem ThemeSwitcherBtn"><svg width="18" height="18" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 18a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" fill="currentColor"/><path fill-rule="evenodd" clip-rule="evenodd" d="M14 4.5V3h-1v1.5h1zM8.7 5.76l-1.06-1.06-.7.71 1.06 1.06.7-.7zM19.3 5.76l1.06-1.06.7.71-1.06 1.06-.7-.7zM4.5 13v1H3v-1h1.5zM21 13v1h1.5v-1H21zM5.76 19.3l-1.06 1.06.71.7 1.06-1.06-.7-.7zM18.24 19.3l1.06 1.06.7-.71-1.06-1.06-.7.7zM14 19.5V21h-1v-1.5h1z" fill="currentColor"/></svg></div>
    </div>

    <!-- 图表容器 -->
    <div id="ChartContainer">
        <div id="Minute" style="display:none;">
            <div id="MinuteCtrl"></div>
        </div>
        <div id="KLine">
            <div id="kline"></div>
        </div>
    </div>

    <!-- ============================================================
         Float Indicator Editor Panel  (Pine Editor style)
         position:fixed — overlays the chart from the right side
         ============================================================ -->
    <div id="floatEditorPanel">

        <!-- Left-edge drag handle (resize panel width) -->
        <div class="fep-resizer" id="fepResizer"></div>

        <!-- Header -->
        <div class="fep-header">
            <span class="fep-title">&#9642; Indicator Editor</span>
            <button class="fep-close" id="btnCloseEditor" title="Close (Esc)">&#10005;</button>
        </div>

        <!-- Top section: Controls (left) | Params (right) -->
        <div class="fep-top">

            <!-- Left column — 4 control rows -->
            <div class="fep-controls">
                <!-- Row 1: name + window select -->
                <div class="fep-ctrl-row">
                    <input class="fep-input" id="index_name" value="MyIndicator1"
                           autocomplete="off" spellcheck="false" data-i18n-ph="idx-name" />
                    <select class="fep-select" id="window_index">
                        <option value="1" data-i18n="idx-sub">Sub Chart</option>
                        <option value="0" data-i18n="idx-main">Main Chart</option>
                    </select>
                </div>
                <!-- Row 2: Run Switch + Run New + Ignore Y -->
                <div class="fep-ctrl-row">
                    <button class="fep-btn fep-btn-primary" id="index_run" data-i18n="idx-run">&#9654; Run</button>
                    <button class="fep-btn" id="add_index_window" data-i18n="idx-new">+ New</button>
                    <label class="fep-check-lbl">
                        <input type="checkbox" id="exclude_y" name="exclude_y" />
                        <span data-i18n="idx-exclude">Ignore Y</span>
                    </label>
                </div>
                <!-- Row 3: Overlay run + Overlay Indep Y -->
                <div class="fep-ctrl-row">
                    <button class="fep-btn" id="overlayindex_run" data-i18n="idx-overlay-run">Overlay</button>
                    <label class="fep-check-lbl">
                        <input type="checkbox" id="overlay_y" name="overlay_y" />
                        <span data-i18n="idx-overlay">Indep. Y</span>
                    </label>
                </div>
                <!-- Row 4: Check Syntax + Save -->
                <div class="fep-ctrl-row">
                    <button class="fep-btn" id="index_check" data-i18n="idx-check">&#10003; Syntax</button>
                    <button class="fep-btn fep-btn-save" id="index_save" data-i18n="idx-save">&#11015; Save</button>
                </div>
            </div><!-- /.fep-controls -->

            <!-- Right column — 4 param rows (M1–M4) -->
            <div class="fep-params">
                <div class="fep-param-row">
                    <input class="fep-pname" id="param_name"   value="M1" />
                    <span  class="fep-peq">=</span>
                    <input class="fep-pval"  id="param_value"  value="5"  type="number" min="1" />
                </div>
                <div class="fep-param-row">
                    <input class="fep-pname" id="param_name_1" value="M2" />
                    <span  class="fep-peq">=</span>
                    <input class="fep-pval"  id="param_value_1" value="10" type="number" min="1" />
                </div>
                <div class="fep-param-row">
                    <input class="fep-pname" id="param_name_2" value="M3" />
                    <span  class="fep-peq">=</span>
                    <input class="fep-pval"  id="param_value_2" value="15" type="number" min="1" />
                </div>
                <div class="fep-param-row">
                    <input class="fep-pname" id="param_name_3" value="M4" />
                    <span  class="fep-peq">=</span>
                    <input class="fep-pval"  id="param_value_3" value="20" type="number" min="1" />
                </div>
            </div><!-- /.fep-params -->

        </div><!-- /.fep-top -->

        <!-- Middle section: Editor (left) | Status/List (right) -->
        <div class="fep-middle">

            <!-- Left: CodeMirror editor -->
            <div class="fep-editor-col">
                <textarea id="tools_code"></textarea>
            </div>

            <!-- Right: tabbed status / list panel -->
            <div class="fep-status-col">
                <div class="fep-tab-bar">
                    <button class="fep-tab active" data-tab="list">指标列表</button>
                    <button class="fep-tab"         data-tab="test">测试结果</button>
                    <button class="fep-tab"         data-tab="xlate">动态翻译</button>
                </div>
                <div class="fep-tab-content">
                    <div class="fep-tab-panel" id="fep-panel-list">
                        <ul id="local_index"></ul>
                    </div>
                    <div class="fep-tab-panel" id="fep-panel-test" style="display:none;">
                        <pre id="fep-test-output">Run "Check Syntax" to see results.</pre>
                    </div>
                    <div class="fep-tab-panel" id="fep-panel-xlate" style="display:none;">
                        <pre id="fep-xlate-output">Run "Check Syntax" to see semantic output.</pre>
                    </div>
                </div>
            </div><!-- /.fep-status-col -->

        </div><!-- /.fep-middle -->

    </div><!-- /#floatEditorPanel -->

    <script src="../jscommon/iyxchart.resource/js/jquery.min.js"></script>
    <script src="../jscommon/iyxchart.resource/js/webfont.js"></script>
    <script src='../jscommon/iyxchart.console.js'></script>     <!-- 日志输出 -->
    <script src="../jscommon/iyxchart.network.js"></script>     <!-- 网络请求分装 -->
    <script src="../jscommon/iyxchart.js"></script>             <!-- K线图形 -->
    <script src="../jscommon/iyxchart.complier.js"></script>    <!-- 麦语言解析执行器 -->
    <script src="../jscommon/iyxchart.index.data.js"></script>  <!-- 基础指标库 -->
    <script src="../jscommon/iyxchart.style.js"></script>       <!-- 白色风格和黑色风格配置信息 -->
    <script src="../jscommon/iyxchart.popMenu.js"></script>
    <script src="../jscommon/iyxchart.DialogDrawTool.js"></script>
    <script src="../jscommon/iyxchart.PopMinuteChart.js"></script>
    <script src="../jscommon/iyxchart.PopKLineChart.js"></script>
    <script src="../jscommon/iyxchart.report.js"></script>
    <script src="../jscommon/iyxchart.keyboard.js"></script>
    <script src="../jscommon/iyxchart.PopKeyboard.js"></script>
    <script src="../jscommon/iyxchart.DialogTooltip.js"></script>
    <script src="../jscommon/iyxchart.DialogSelectRect.js"></script>
    <script src="../jscommon/iyxchart.DialogSearchIndex.js"></script>
    <script src="../jscommon/iyxchart.version.js"></script>

    <!-- 公式编辑器 -->
    <script src="../jscommon/iyxchart.resource/js/codemirror/codemirror.js"></script>
    <script src="../jscommon/iyxchart.resource/js/codemirror/javascript.js"></script>

    <!-- IYX 公式高亮模式 — 独立 tokenizer，必须在 fromTextArea() 之前加载 -->
    <script>
    (function() {

        /* ── 数据字段 → token: 'keyword'  ────────────────────────────── */
        var DATA_KWORDS = new Set([
            'CLOSE','OPEN','HIGH','LOW','VOL','AMOUNT','VOLR','CAPITAL',
            'C','O','H','L','V','A',
            'BARPOS','BARSCOUNT','BACKSET','BARSLAST',
            'DATE','TIME','DAY','WEEK','MONTH','YEAR',
            'ISLASTBAR','ISUP','ISDOWN'
        ]);

        /* ── 内置函数 → token: 'builtin'  ────────────────────────────── */
        var BUILTIN_FUNS = new Set([
            'MA','EMA','SMA','WMA','DMA','EXPMA','EXPMEMA',
            'MACD','DIF','DEA','RSI','KDJ','BOLL','ATR','CCI','WR','BIAS','DMI','ADX',
            'ROC','MOM','TRIX','CR','PSY','DPO','VHF','MASS',
            'CROSS','LONGCROSS','COUNT','COUNTIF','SUM','FILTER',
            'ABS','MAX','MIN','ROUND','CEILING','FLOOR','MOD','AVEDEV',
            'REF','REFV','LLV','HHV','LLVBARS','HHVBARS','SLOPE','FORCAST',
            'IF','IFF','IFN','INTPART','FRACT',
            'DRAWTEXT','DRAWKLINE','DRAWICON','DRAWARROW','DRAWRECTREL',
            'DRAWLINE','DRAWNUMBER','DRAWBAND','DRAWBMP','DRAWNULL',
            'DRAWLASTBARTEXT','DRAWLASTBARNUMBER','DRAWCOLORKLINE',
            'FILLRGN','PLOYLINE','PARTLINE','COLORSTICK','STICKLINE','LINENULL',
            'ALIGN0','ALIGN1','ALIGN2','ALIGN3',
            'VALIGN0','VALIGN1','VALIGN2','VALIGN3',
            'FONTSIZE8','FONTSIZE9','FONTSIZE10','FONTSIZE11','FONTSIZE12',
            'FONTSIZE14','FONTSIZE16','FONTSIZE18','FONTSIZE20','FONTSIZE24',
            'STICK','DOTLINE','NODRAW','NOFRAME','NOAXIS',
            'LINETHICK1','LINETHICK2','LINETHICK3','LINETHICK4','LINETHICK5',
            'BACKGROUND','YMOVE','TEXTPOS','OFFSET','RGBA','RGB'
        ]);

        /* ── 颜色常量 → token: 'clr-X'                                  */
        /*    颜色值来源: JSComplier.ColorVarToRGB                        */
        /*    CSS 类: .cm-clr-X — 每个常量用其真实颜色值渲染              */
        var COLOR_TOKEN = {
            'COLORBLACK':    'clr-black',
            'COLORBLUE':     'clr-blue',
            'COLORGREEN':    'clr-green',
            'COLORCYAN':     'clr-cyan',
            'COLORRED':      'clr-red',
            'COLORMAGENTA':  'clr-magenta',
            'COLORBROWN':    'clr-brown',
            'COLORLIGRAY':   'clr-ligray',
            'COLORGRAY':     'clr-gray',
            'COLORLIBLUE':   'clr-liblue',
            'COLORLIGREEN':  'clr-ligreen',
            'COLORLICYAN':   'clr-licyan',
            'COLORLIRED':    'clr-lired',
            'COLORLIMAGENTA':'clr-limagenta',
            'COLORWHITE':    'clr-white',
            'COLORYELLOW':   'clr-yellow'
        };

        CodeMirror.defineMode('iyx-formula', function() {
            return {
                startState: function() { return { inBlock: false }; },

                token: function(stream, state) {
                    if (stream.eatSpace()) return null;

                    /* 块注释 { ... } — 最高优先级，防止内部关键词被误高亮 */
                    if (state.inBlock) {
                        if (stream.match('}')) state.inBlock = false;
                        else stream.next();
                        return 'comment';
                    }
                    if (stream.peek() === '{') {
                        stream.next(); state.inBlock = true; return 'comment';
                    }

                    /* 行注释 // */
                    if (stream.match('//')) { stream.skipToEnd(); return 'comment'; }

                    /* 字符串 '...' */
                    if (stream.peek() === "'") {
                        stream.next();
                        while (!stream.eol() && stream.peek() !== "'") stream.next();
                        if (!stream.eol()) stream.next();
                        return 'string';
                    }

                    /* 数字（整数 / 浮点） */
                    if (stream.match(/^[0-9]+(\.[0-9]+)?/)) return 'number';

                    /* 标识符 — 优先级：颜色常量 > 数据字段 > 内置函数 > 用户变量 */
                    if (stream.match(/^[A-Za-z_][A-Za-z0-9_]*/)) {
                        var word = stream.current().toUpperCase();
                        if (COLOR_TOKEN[word])       return COLOR_TOKEN[word];
                        if (DATA_KWORDS.has(word))   return 'keyword';
                        if (BUILTIN_FUNS.has(word))  return 'builtin';
                        return 'variable';
                    }

                    /* 运算符 / 标点 */
                    stream.next();
                    return 'operator';
                }
            };
        });

    })();
    </script>

    <script src="../jscommon/iyxchart.testdata/60000.sh.capital.kline.js"></script>
    <script src="../jscommon/iyxchart.testdata/60000.sh.NewsInteract.js"></script>
    <script src="../jscommon/iyxchart.testdata/60000.sh.BlockTrading.js"></script>
    <script src="../jscommon/iyxchart.testdata/60000.sh.TradeDetal.js"></script>
    <script src="../jscommon/iyxchart.testdata/60000.sh.finance_7.js"></script>

    <script src="../jscommon/iyxchart.testdata/symbollist_shsz.js"></script>

    <!-- 分钟K线 -->
    <script src="../jscommon/iyxchart.testdata/M1KLine/600000.sh.minute.kline.js"></script>
    <script src="../jscommon/iyxchart.testdata/M1KLine/000001.sh.minute.kline.js"></script>
    <script src="../jscommon/iyxchart.testdata/M1KLine/000300.sh.minute.kline.js"></script>
    <script src="../jscommon/iyxchart.testdata/M1KLine/399001.sz.minute.kline.js"></script>
    <script src="../jscommon/iyxchart.testdata/M1KLine/000001.sz.minute.kline.js"></script>
    <script src="../jscommon/iyxchart.testdata/M1KLine/399006.sz.minute.kline.js"></script>
    <script src="../jscommon/iyxchart.testdata/M1KLine/399005.sz.minute.kline.js"></script>
    <script src="../jscommon/iyxchart.testdata/M1KLine/000151.sz.minute.kline.js"></script>

    <script src="../jscommon/iyxchart.testdata/M1KLine/ICL8.cfe.minute.kline.js"></script>
    <script src="../jscommon/iyxchart.testdata/M1KLine/IML8.cfe.minute.kline.js"></script>
    <script src="../jscommon/iyxchart.testdata/M1KLine/IFL8.cfe.minute.kline.js"></script>

    <!--日K -->
    <script src="../jscommon/iyxchart.testdata/DayKLine/600000.sh.day.kline.js"></script>
    <script src="../jscommon/iyxchart.testdata/DayKLine/000001.sh.day.kline.js"></script>
    <script src="../jscommon/iyxchart.testdata/DayKLine/000300.sh.day.kline.js"></script>
    <script src="../jscommon/iyxchart.testdata/DayKLine/399001.sz.day.kline.js"></script>
    <script src="../jscommon/iyxchart.testdata/DayKLine/000001.sz.day.kline.js"></script>
    <script src="../jscommon/iyxchart.testdata/DayKLine/399006.sz.day.kline.js"></script>
    <script src="../jscommon/iyxchart.testdata/DayKLine/399005.sz.day.kline.js"></script>
    <script src="../jscommon/iyxchart.testdata/DayKLine/000151.sz.day.kline.js"></script>

    <script src="../jscommon/iyxchart.testdata/DayKLine/ICL8.cfe.day.kline.js"></script>
    <script src="../jscommon/iyxchart.testdata/DayKLine/IML8.cfe.day.kline.js"></script>
    <script src="../jscommon/iyxchart.testdata/DayKLine/IFL8.cfe.day.kline.js"></script>

    <!-- 单日分时图 -->
    <script src="../jscommon/iyxchart.testdata/DayMinute/000001.sz.1day.minute.js"></script>
    <script src="../jscommon/iyxchart.testdata/DayMinute/600000.sh.1day.minute.js"></script>
    <script src="../jscommon/iyxchart.testdata/DayMinute/000151.sz.1day.minute.js"></script>

    <!-- 多日分时数据 -->
    <script src="../jscommon/iyxchart.testdata/Day5Minute/600000.sh.5day.minute.js"></script>
    <script src="../jscommon/iyxchart.testdata/Day5Minute/000001.sz.5day.minute.js"></script>
    <script src="../jscommon/iyxchart.testdata/Day5Minute/000151.sz.5day.minute.js"></script>

    <script src="../jscommon/iyxchart.testdata.js"></script>

    <script>

        MARKET_SUFFIX_NAME.GetMarketStatus = function (symbol)  { return 2; }

        //默认显示的指标代码
        var DEFAULT_CODE='MA1:MA(CLOSE,M1);\n\MA2:MA(CLOSE,M2);\n\MA3:MA(CLOSE,M3);\n\MA4:MA(CLOSE,M4);\nDRAWICON(C>O,H,5);';

        // 全局控件实例（供周期切换函数访问）
        var klineControl = null;
        var minuteControl = null;
        var g_isKLine = true;           // 当前显示的是K线图(true)还是分时图(false)
        var g_activeTabId = 'KLineDay'; // 当前选中的tab id
        var g_currentTheme = 'black';   // 当前皮肤：'black' | 'white'
        var g_currentLang  = 'EN';      // 当前语言：'EN' | 'CN'

        // ================================================================
        // X 轴标签上下文感知格式化
        // ================================================================
        //
        // IYXChart 数据格式：
        //   kItem.Date  ── 整数 YYYYMMDD，如 20260219
        //   kItem.Time  ── 整数 HHMM，    如 930（= 09:30）、1430（= 14:30）
        //
        // 参数：
        //   current    ── { Date:number, Time:number }，当前刻度的 kItem（或同结构对象）
        //   previous   ── 同上，上一个刻度；第一个刻度传 null
        //   zoomLevel  ── 当前可视区域跨越的 日历天数（number）
        //
        // 返回值（string）：
        //   日内   (≤2天)  跨天 → "MM-DD"，同天 → "HH:mm"
        //   中跨度 (<30天) 跨月 → "MM-DD"，同月 → "DD"
        //   大跨度 (≥30天) 跨年 → "YYYY-MM"，同年 → "MM"
        //
        function formatAxisLabel(current, previous, zoomLevel)
        {
            // ── 解包当前刻度 ────────────────────────────────────────────
            var cDateInt = current.Date;
            var cY  = Math.floor(cDateInt / 10000);
            var cM  = Math.floor(cDateInt / 100) % 100;
            var cD  = cDateInt % 100;
            var cTimeInt = current.Time || 0;
            var cH  = Math.floor(cTimeInt / 100);
            var cMi = cTimeInt % 100;

            var pad = function(n) { return n < 10 ? '0' + n : '' + n; };

            // ── 解包上一刻度（null = 第一个刻度，各 boundary 均视为 true）─
            var isFirst = (previous == null);
            var pY = isFirst ? -1 : Math.floor(previous.Date / 10000);
            var pM = isFirst ? -1 : Math.floor(previous.Date / 100) % 100;
            var pD = isFirst ? -1 : previous.Date % 100;

            var newYear  = isFirst || (cY !== pY);
            var newMonth = isFirst || (cM !== pM) || newYear;
            var newDay   = isFirst || (cD !== pD)  || newMonth;

            // ── 格式化分支 ──────────────────────────────────────────────
            if (zoomLevel <= 2)
            {
                // 极小跨度（日内 / 跨 1 天）
                // 跨天边界：显示日期；日内其余刻度：仅显示时间
                return newDay
                    ? pad(cM) + '-' + pad(cD)
                    : pad(cH) + ':' + pad(cMi);
            }

            if (zoomLevel < 30)
            {
                // 中等跨度（2 天 < span < 30 天）
                // 跨月：显示 MM-DD；同月：仅显示 DD
                return newMonth
                    ? pad(cM) + '-' + pad(cD)
                    : pad(cD);
            }

            // 大跨度（span ≥ 30 天）
            // 跨年：显示 YYYY-MM；同年：仅显示 MM
            return newYear
                ? cY + '-' + pad(cM)
                : pad(cM);
        }

        /* ── 使用示例（在自定义 drawXAxis 循环中）────────────────────────
        //
        // zoomLevel 的计算方式（以 K 线图为例）：
        //   var data      = klineControl.Chart.ChartFrame.SubFrame[0].Frame.Data.Data;
        //   var visible   = klineControl.Chart.ChartFrame.SubFrame[0].Frame.XSplitOperator;
        //   var startIdx  = visible.DataStartIndex;
        //   var endIdx    = visible.DataEndIndex;
        //   var startDate = data[startIdx].Date;          // e.g. 20260101
        //   var endDate   = data[endIdx  ].Date;          // e.g. 20260219
        //   // 将整数日期近似换算成天数差（忽略非交易日误差，已足够驱动分支判断）
        //   var sy = Math.floor(startDate/10000), sm = Math.floor(startDate/100)%100, sd = startDate%100;
        //   var ey = Math.floor(endDate/10000),   em = Math.floor(endDate/100)%100,   ed = endDate%100;
        //   var zoomLevel = (ey-sy)*365 + (em-sm)*30 + (ed-sd);
        //
        // drawXAxis 调用示例：
        //
        //   function drawXAxis(ctx, xAxisPoints, zoomLevel) {
        //       ctx.save();
        //       ctx.font      = GetDevicePixelRatio() * 12 + 'px "Trebuchet MS", Arial, sans-serif';
        //       ctx.fillStyle = '#707481';          // TradingView 刻度色
        //       ctx.textAlign    = 'center';
        //       ctx.textBaseline = 'top';
        //
        //       var previous = null;
        //       xAxisPoints.forEach(function(point) {
        //           // point = { x: canvasX, kItem: { Date, Time } }
        //           var label = formatAxisLabel(point.kItem, previous, zoomLevel);
        //           ctx.fillText(label, point.x, point.y);
        //           previous = point.kItem;
        //       });
        //
        //       ctx.restore();
        //   }
        ─────────────────────────────────────────────────────────────── */

        // ================================================================
        // 国际化字典
        // ================================================================
        var I18N_MAP = {
            // EN map：按钮显示"中"表示"点我切到中文"
            EN: {
                'time':  'Time', '5d':    '5D',  '1d':    '1D',
                'w':     'W',    'm':     'M',   'y':     'Y',
                '1min':  '1M',   '5min':  '5M',  '15min': '15M', '30min': '30M',
                'chip':  'Chip', 'pre':   'Pre', 'draw':  'Draw',
                'search':'Symbol / Name',
                'lang':  '中',   // 当前EN，按钮显示目标语言"中"
                // 编辑器工具栏
                'idx-name':'Indicator Name:', 'idx-sub':'Sub Chart',  'idx-main':'Main Chart',
                'idx-exclude':'Ignore Y-Axis','idx-run':'Run (Switch)','idx-new':'Run (New)',
                'idx-check':'Check Syntax',   'idx-save':'Save',
                'idx-overlay':'Overlay Indep. Y','idx-overlay-run':'Overlay Run',
                'idx-param':'Arguments',      'idx-value':'Value',
            },
            // CN map：按钮显示"EN"表示"点我切回英文"
            CN: {
                'time':  '分时',  '5d':    '5日',   '1d':    '日线',
                'w':     '周线',  'm':     '月线',  'y':     '年线',
                '1min':  '1分钟', '5min':  '5分钟', '15min': '15分钟', '30min': '30分钟',
                'chip':  '筹码',  'pre':   '竞价',  'draw':  '画线',
                'search':'代码/名称',
                'lang':  'EN',   // 当前CN，按钮显示目标语言"EN"
                // 编辑器工具栏
                'idx-name':'指标名称：',       'idx-sub':'副图',       'idx-main':'主图',
                'idx-exclude':'不参与Y轴计算', 'idx-run':'执行(切换)', 'idx-new':'执行(新建)',
                'idx-check':'语法检测',        'idx-save':'保存指标',
                'idx-overlay':'叠加指标独立坐标','idx-overlay-run':'执行(叠加)',
                'idx-param':'参数',            'idx-value':'数值',
            }
        };

        function switchLanguage()
        {
            var nextLang = (g_currentLang === 'EN') ? 'CN' : 'EN';
            g_currentLang = nextLang;
            var map = I18N_MAP[nextLang];
            document.querySelectorAll('[data-i18n]').forEach(function(el)
            {
                var key  = el.getAttribute('data-i18n');
                var text = map[key];
                if (!text) return;
                if (el.tagName === 'INPUT') {
                    el.placeholder = text;          // 搜索框只更新 placeholder
                } else if (!el.querySelector('svg')) {
                    el.textContent = text;          // 普通 Tab 更新文字，跳过含 SVG 的图标按钮
                }
            });
        }

        //简单的把K线控件封装下
        function KLineChart(divKLine)
        {
            this.DivKLine=divKLine;
            this.Chart=JSChart.Init(divKLine, false, true);   //把K线图绑定到一个Div上
            this.IndexEdit;

            this.MapIndex=new Map();    //本地指标

            this.JSPopMenu=null;

            this.JSPopMenu=new JSPopMenu();
            this.JSPopMenu.Inital();

            //K线配置信息
            this.Option= {
                Type:'历史K线图',   //创建图形类型
                //Type:'历史K线图横屏',

                //EnableBorderDrag:false,

                Windows: //窗口指标
                [
                    //{Index:"EMPTY", TitleHeight:1},
                    {
                        Index:"MA", Overlay:true, AddIndexWindow:true
                        //TitleArrowType:1,
                        //HorizontalReserved:{ Top:50, Bottom:50 }
                    },
                    //{ Index:"OX", Overlay:true, },
                    {Index:"MACD", },
                    {Index:"VOL", Overlay:true, YAxis: { FloatPrecision:0, StringFormat:2 } },
                ],


                OverlayIndex:
                [
                   //{ Index:'MA', Windows:0 , IsShareY:true, ShowRightText:false , IsShowIndexTitle:true, FloatPrecision:5 },
                    //{Index:'RSI', Windows:0, ShowRightText:false },
                    //{ Index:'BOLL', Windows:0, ShowRightText:true,IsShareY:true, ShowToolbar:true },
                   // {Windows:0, IndexName:"指标ID", Name:"自定义指标", Script:"DRAWTEXT(CLOSE>OPEN,LOW,'看多'),ALIGN1,VALIGN0,YMOVE(5),FONTSIZE14,BACKGROUND(RGBA(255, 69, 0,0.5),RGB(255,0,0), 1,1,1,1),RGB(230,230,230);", Identify:"guid_66990",ShowRightText:true,IsShareY:true }
                    //{Index:'MA5', Windows:1 ,ShowRightText:true}
                    //{Index:"VOL_OVERLAY", Windows:0 },
                ],  //叠加指标


                //OverlayIndexFrameWidth:1,
                //DragDownload: { Day:{ Enable:true } , Minute:{ Enable:true }},

                EnableZoomUpDown:
                {
                    //Wheel:false,
                    //Keyboard:false,
                    //Touch:false,
                },

                EnableYDrag:
                {
                    Right:true,
                    Left:true,
                    Wheel:true,
                },

                //Language:'EN',

                Symbol:"600000.sh",
                IsAutoUpdate:true,       //是自动更新数据
                AutoUpdateFrequency:3000,   //数据更新频率
                //TradeIndex: {Index:'交易系统-BIAS'},    //交易系统

                SplashTitle:'加载数据中......',

                IsShowRightMenu:true,          //右键菜单
                //CorssCursorTouchEnd:true,
                //IsClickShowCorssCursor:true,
                //IsCorssOnlyDrawKLine:true,

                CtrlMoveStep:10,
                EnablePopMenuV2:true,
                EnableDrawToolDialogV2:true,
                EnableModifyDrawDialogV2:true,
                EnableResize:true,
                EnableTooltipDialog:true,

                TooltipDialog:{ Enable:true, Style:1 },
                SelectRectDialog:{ Enable:true },
                KLineTooltip:{ Enable:true, EnableKeyDown:false },
                FloatTooltip:{ Enable:false },
                SmallFloatTooltip:{ Enable:false },
                FloatLayer:{ Enable:false },
                SearchIndexDialog:{ Enable:true },
                ModifyIndexParamDialog:{ Enable:true },

                //双击K线图 弹分时图配置
                PopMinuteChart:
                {
                    Enable:true,
                    EnableMarkBG:true,
                    Option:
                    {
                        Windows:
                        [
                            { Index:"RSI", Overlay:false,MaxMin:false }
                        ]
                    }
                },

                //EnableVerifyRecvData:true,

                CorssCursorInfo: { Right:1, Bottom:1, DateFormatType:3, HPenType:1, VPenType:1, IsShowClose:false, VLineType:0,RightButton:{ Enable:true }, IsShowCorss:true, PriceFormatType:0, DataFormatType:0, EnableKeyboard:true },
                EnableZoomIndexWindow:true,

                DrawTool:       //画图工具
                {
                    //StorageKey:'4E7EA133-D6C8-4776-9869-1DDDCC5FA788'
                },

                KLine:  //K线设置
                {
                    DragMode:1,                 //拖拽模式 0=禁止拖拽 1=数据拖拽 2=区间选择
                    Right:1,                    //复权 0 不复权 1 前复权 2 后复权
                    Period:0,                   //周期 0 日线 1 周线 2 月线 3 年线
                    MaxRequestDataCount:8000,   //数据个数
                    MaxRequestMinuteDayCount:100, //分钟数据获取几天数据  默认取5天数据

                    //Info:["互动易","大宗交易",'龙虎榜',"调研","业绩预告","公告"],       //信息地雷
                    //Info:["公告"],
                    //InfoPosition:0,
                    IsShowTooltip:true,                 //是否显示K线提示信息
                    DrawType:0,      //K线类型 0=实心K线柱子 1=收盘价线 2=美国线 3=空心K线柱子 4=收盘价面积图
                    //FirstShowDate:20161201,
                    //KLineDoubleClick:true, //禁止双击弹框 (废弃 使用(PopMinuteChart:{ }))
                    RightSpaceCount:2,
                    ZoomType:0,
                    //OneLimitBarType:1,

                    //PageSize:30,               //一屏显示多少数据
                    DataWidth:10,
                },

                StepPixel:0,

                IsDrawPictureXY:true,

                Listener:
                {
                    //KeyDown:false,
                    //Wheel:false
                },

                SelectedChart:{ EnableSelected: true, EnableMoveOn:true },
                EnableIndexChartDrag:true,

                GlobalOption:{ SelectedBorder:{ Mode:1} },

                SelectRect:
                {
                    Mark:{ IsShow:true, Position:{ Top:"TopEx" } }
                },

                KLineTitle: //标题设置
                {
                    IsShowName:true,       //不显示股票名称
                    IsShowSettingInfo:true, //不显示周期/复权
                    IsTitleShowLatestData:true,
                },

                //DragDownload: { Day:{ Enable:true } },   //拖拽下载


                DragSelectRect:
                {
                    Enable:true,
                    ShowMode:2,
                    //ZIndex:3,
                },

                Border: //边框
                {
                    Left:1,         //左边间距
                    Right:20,       //右边间距
                    Bottom:18,      //底部间距
                    Top:25,         //顶部间距

                    AutoLeft:{ Blank:10, MinWidth:60 },
                    AutoRight:{ Blank:5, MinWidth:60 },
                },

                Frame:  //子框架设置
                [
                    {
                        SplitCount:12,      // Y轴横线数（增密，每格约40px）
                        MinYDistance: 40,   // 纵坐标刻度最小像素间距
                        XSplitCount:15,     // X轴竖线数（半边），全图约30条
                        IsShowXLine:true,   // 显示竖向网格线
                        IsShowYLine:true,   // 显示横向网格线
                        //SplitType:1,
                        Custom:
                        [

                            {
                                Type:0,

                                Position:'right', LineType:1,
                                //PositionEx:1,
                            },

                        ]



                    },

                    { SplitCount:5, MinYDistance: 40, BottomSpace:18,FilterType:1 },
                    { SplitCount:4, MinYDistance: 40, FilterType:1 }
                ],

                ExtendChart:    //扩展图形
                [
                    //{Name:'KLineTooltip' },  //手机端tooltip
                    //{Name:"FrameSplitPaint", LineColor:"rgb(200,0,0)" }
                    //{Name:"SessionBreaksPaint"}
                    //{ Name:"StockChipPhone" }
                ],


                Overlay:
                [
                    //{ Symbol:'399300.sz', DrawType:1, Color:'rgb(0,0,255)'},
                    //{ Symbol:'600999.sh' }
                ],
            };

            this.Create=function()  //创建图形
            {
                var self=this;
                $(window).resize(function() { self.OnSize(); });    //绑定窗口大小变化事件

                // ---- TradingView 默认深色皮肤初始化 ----
                var resource=JSChart.GetResource();
                resource.BGColor             = '#131722';
                resource.UpBarColor          = '#089981';
                resource.DownBarColor        = '#f23645';
                resource.FrameBorderPen      = 'rgba(42,46,57,0.8)';
                resource.FrameSplitPen       = 'rgba(200,200,200,0.25)';  // 网格线：浅灰低透明度，深蓝底上清晰可见
                resource.FrameXLineDash      = [1,1];                    // 竖向网格虚线（细密）
                resource.FrameSplitTextColor = '#707481';   // TV 深色坐标轴刻度色（比主文字暗一档）
                resource.DefaultTextColor    = '#d1d4dc';   // TV 主文字色（淡灰）
                resource.FrameTitleBGColor   = '#131722';
                // TradingView 字体：全量覆盖所有 canvas 文字
                var _dpr = GetDevicePixelRatio();
                var _f   = _dpr * 12 + 'px "Trebuchet MS", Arial, sans-serif';
                resource.DefaultTextFont          = _f;   // 通用文字
                resource.FrameSplitTextFont       = _f;   // 坐标轴刻度（Time / Price 标签）
                resource.TitleFont                = _f;   // 指标标题栏（MACD / VOL / MA）
                resource.OverlayFrame.TitleFont   = _f;   // 叠加指标名称
                resource.CorssCursorTextFont      = _f;   // 十字光标文字

                this.DivKLine.style.backgroundColor=resource.BGColor; //设置最外面的div背景

                this.Option.EventCallback=
                [
                    {
                        event:JSCHART_EVENT_ID.ON_FORMAT_KLINE_FLOAT_TOOLTIP,
                        callback:(event, data, obj)=>{ this.OnFormatKLineFloatTooltip(event, data, obj); }
                    },
                    {
                        event:JSCHART_EVENT_ID.ON_CREATE_FRAME,
                        callback:(event, data, obj)=>{ this.OnCreateFrame(event, data, obj); }
                    },
                    {
                        event:JSCHART_EVENT_ID.ON_DELETE_FRAME,
                        callback:(event, data, obj)=>{ this.OnDeleteFrame(event, data, obj); }

                    },
                    {
                        event:JSCHART_EVENT_ID.ON_SPLIT_YCOORDINATE,
                        callback:(event, data, obj)=>{ this.OnSplitYCoordinate(event, data, obj); }
                    },
                    {
                        event:JSCHART_EVENT_ID.ON_SPLIT_XCOORDINATE,
                        callback:(event, data, obj)=>{ this.OnSplitXCoordinate(event, data, obj); }
                    },
                    {
                        event:JSCHART_EVENT_ID.ON_CREATE_OVERLAY_FRAME,
                        callback:(event, data, obj)=>{ this.OnCreateOverlayFrame(event, data, obj); }
                    },
                    {
                        event:JSCHART_EVENT_ID.ON_CREATE_CUSTOM_Y_COORDINATE,
                        callback:(event, data, obj)=>{ this.OnCreateCustomYCoordinate(event, data, obj); }
                    },
                    {
                        event:JSCHART_EVENT_ID.ON_TITLE_DRAW,
                        callback:(event, data, obj)=>{ this.OnTitleDraw(event, data, obj); }
                    },
                    {
                        event:JSCHART_EVENT_ID.ON_CLICK_EXTENDCHART_BUTTON,
                        callback:(event, data, obj)=>{ this.OnClickExtendChartButton(event, data, obj); }
                    },
                    {
                        event:JSCHART_EVENT_ID.ON_CHANGE_INDEX,
                        callback:(event, data, obj)=>{ this.OnChangeIndex(event, data, obj); }

                    },
                    {
                        event:JSCHART_EVENT_ID.ON_CLICK_TITLE_BUTTON,
                        callback:(event, data, obj)=>{ this.OnClickTitleButton(event, data, obj); }
                    },
                    {
                        event:JSCHART_EVENT_ID.ON_CREATE_RIGHT_MENU,
                        callback:(event, data, obj)=>{ this.OnCreateRightMenu(event, data, obj); }
                    },
                    {
                        event:JSCHART_EVENT_ID.ON_MENU_COMMAND,
                        callback:(event, data, obj)=>{ this.OnMenuCommand(event, data, obj); }
                    },
                    {
                        event:JSCHART_EVENT_ID.ON_CLICK_CROSSCURSOR_RIGHT,
                        callback:(event, data, obj)=>{ this.ClickCrossCursor(event, data, obj); }
                    },
                    {
                        event:JSCHART_EVENT_ID.RECV_HISTROY_DATA,
                        callback:(event, data, obj)=>{ this.OnRecvHistoryData(event, data, obj); }
                    },
                    {
                        event:JSCHART_EVENT_ID.ON_FORMAT_KLINE_HIGH_LOW_TITLE,
                        callback:(event, data, obj)=>{ this.OnFormatKLineHighLowTitle(event, data, obj); }
                    },
                    {
                        event:JSCHART_EVENT_ID.ON_FORMAT_INDEX_OUT_TEXT,
                        callback:(event, data, obj)=>{ this.OnFormatIndexOutText(event, data, obj); }
                    },
                    {
                        event:JSCHART_EVENT_ID.ON_CALCULATE_CHIP_DATA,
                        callback:(event, data, obj)=>{ this.OnCalculateChipData(event, data, obj); }
                    },
                    {
                        event:JSCHART_EVENT_ID.ON_SIZE_FRAME,
                        callback:(event, data, obj)=>{ this.OnSizeFrame(event, data, obj); }
                    }

                ];

                this.OnSize();  //让K线全屏
                this.Option.OnCreatedCallback=(chart)=>{ this.OnCreateTKChart(chart); }
                this.Option.ScriptError=(error)=> { this.ExecuteScriptError(error); }
                this.Option.NetworkFilter=(data, callback)=>{ this.NetworkFilter(data, callback); }
                this.Chart.SetOption(this.Option);  //设置K线配置


                this.UpdateWindowsSelectDOM();
            }

            this.OnCreateTKChart=function(chart)
            {
                var chart=chart.GetRectSelectPaint();
                if (chart)
                {
                    //chart.IsOnlyOnePoint=true;
                }

            }

            this.NetworkFilter=function(data, callback)
            {
                console.log(`[HQData::NetworkFilter] ${HQData.Explain}`, data);

                switch(data.Name)
                {
                    case 'JSSymbolData::GetSymbolData':                 //分时图数据对接
                        this.GetSymbolData(data, callback);
                        break;
                    case "KLineChartContainer::RequestDragDayData":
                        break;
                    default:
                        HQData.NetworkFilter(data, callback);
                        break;
                }
            }

            this.GetSymbolData=function(data, callback)
            {
                data.PreventDefault=true;
                var symbol=data.Request.Data.symbol;
                var period=data.Request.Data.period;
                if (this.Chart.JSChartContainer.Symbol==symbol)
                {
                    if (ChartData.IsDayPeriod(period, true))
                        HQData.RequestHistoryData(data, callback);
                    else if (ChartData.IsMinutePeriod(period, true))
                        HQData.RequestHistoryMinuteData(data, callback);
                }
            }

            this.OnCreateFrame=function(event, data, obj)
            {
                var frame=data.SubFrame.Frame;
                frame.IsShowYText[0]=false;
                frame.IsShowXLine=false;
                frame.IsDrawRightBorder=true;
                frame.IsDrawLeftBorder=false;
                frame.YTextPadding[0]=5;
                frame.YTextPadding[1]=5;
                frame.YLineExtend=[{ Width:5, Color:frame.PenBorder}, { Width:5, Color:frame.PenBorder} ];
                frame.YTextExtend=[{ Align:0 }, { Align:2} ];
                frame.XTextExtend=[{ Align:1 } ];
                frame.XLineExtend=[{ Mode:1, Color:frame.PenBorder }];

                var button =
				{
					ID: 8888,
                    IsLeft:true,
					Style:  //按钮样式 使用iconfont， 可以放全局的资源配置里面
					{
						MoveOnColor: "rgb(255,255,255)",
						Color: "rgb(156,156,156)",
						Family: "iconfont",
						Text: "\ue691",
						Size: 13 *GetDevicePixelRatio(),
						MerginLeft: 2,
                        YMoveOffset:-1,
					},
					TooltipText: "指标设置",
                    Data:{ FrameID:frame.Identify, ID:"DrapDownMenu" }
				};

                frame.CustomToolbar = [button];   //按钮添加

                if (frame.Identify==1)
                {
                    var chart=obj.GetExtendChartByClassNameV2("FrameButtomToolbarPaint");
                    if (!chart)
                    {
                        var  aryButton=
                        [
                            { Title:"MACD", ID:"F_BTN_01", TooltipText:"MACD:平滑异同平均", Data:{ IndexID:"MACD"}},
                            { Title:"RSI", ID:"F_BTN_02", TooltipText:"RSI:相对强弱指标", Data:{ IndexID:"RSI"} },
                            { Title:"CCI", ID:"F_BTN_03",TooltipText:"CCI:商品路径指标", Data:{ IndexID:"CCI"} },
                            { Title:"ATR", ID:"F_BTN_04", TooltipText:"ATR:说明......", Data:{ IndexID:"ATR"}},
                            { Title:"VMACD", ID:"F_BTN_05",TooltipText:"VMACD:说明......", Data:{ IndexID:"VMACD"}},
                            { Title:"BRAR", ID:"F_BTN_06", TooltipText:"BRAR:说明......", Data:{ IndexID:"BRAR"}},
                            { Title:"更多指标", ID:"F_BTN_07", TooltipText:"更多更多......", SVGButton:{ Symbol:"\ue694", }, Data:{ } },

                            { Title:"新增窗口", ID:"F_BTN_08", TooltipText:"新增加一个新的指标窗口", Data:{ }},
                            //{ SVGButton:{ Symbol:"\ue694", }, ID:"F_BTN_08", Data:{ } }
                        ];

                        obj.CreateExtendChart("FrameButtomToolbarPaint", { FrameID:frame.Identify, AryButton:aryButton } );
                    }


                    //frame.HorizontalReserved={ Top:50, Bottom:30 };

                }

                this.UpdateWindowsSelectDOM();
            }
 
            this.OnDeleteFrame=function(event, data, obj)
            {
                var selectDom=document.getElementById('window_index');
                selectDom.options.length=0;

                var lWindowCount=this.Chart.JSChartContainer.Frame.SubFrame.length-1;
                for(var i=0;i<lWindowCount;++i)
                {
                    var name=`附图-${i}`;
                    if (i==0) name="主图";

                    selectDom.add(new Option(name, i));
                }
            }

            this.OnCreateOverlayFrame=function(event, data, obj)
            {
                var mainFrame=data.SubFrame.Frame;
                var frame=data.OverlayFrame.Frame;
                frame.PenBorder=mainFrame.PenBorder;
                frame.YTextPadding[1]=5;
                frame.Style=1;
                frame.IsShowTitle=false;
                //frame.YLineExtend=[ { Width:5 }, null];
                frame.YLineExtend=[null, { Width:5 } ];
                frame.YTextExtend=[null, { Align:2}  ];

                var button =
				{
					ID: 8889,
                    IsLeft:true,
					Style:  //按钮样式 使用iconfont， 可以放全局的资源配置里面
					{
						MoveOnColor: "rgb(255,255,255)",
						Color: "rgb(156,156,156)",
						Family: "iconfont",
						Text: "\ue691",
						Size: 13 *GetDevicePixelRatio(),
						MerginLeft: 2,
                        YMoveOffset:-2,
					},
					TooltipText: `指标设置`,
                    Data:{ IndexGuid:data.OverlayFrame.Identify, ID:"DrapDownMenu" }
				};

                frame.CustomToolbar = [button];   //按钮添加
            }

            this.OnSplitYCoordinate=function(event, data ,obj)
            {

            }

            this.OnSplitXCoordinate=function(event, data, obj)
            {
                console.log("[OnSplitXCoordinate] data ", data);
            }

            this.OnCreateCustomYCoordinate=function(event, data ,obj)
            {
                console.log("[OnCreateCustomYCoordinate] data ", data);
                if (data.ID==0)
                {
                    var info=new CoordinateInfo();
                    info.Type=5;
                    info.Value=7;
                    info.AreaData={  Value:[6.0, 7.0], BGColor:"rgba(249,210,88,0.5)", Position:[0, 1 ] }
                    data.Frame.CustomHorizontalInfo.push(info);

                    var info=new CoordinateInfo();
                    info.Type=5;
                    info.Value=8;
                    info.AreaData={  Value:[7.0, 8.0], BGColor:"rgba(93,202,119,0.5)", Position:[0, 1 ] }
                    data.Frame.CustomHorizontalInfo.push(info);

                    var info=new CoordinateInfo();
                    info.Type=5;
                    info.Value=9;
                    info.AreaData={  Value:[8.0, 9.0], BGColor:"rgba(43,190,174,0.5)", Position:[0, 1 ] }
                    data.Frame.CustomHorizontalInfo.push(info);

                    var info=new CoordinateInfo();
                    info.Type=5;
                    info.Value=10;
                    info.AreaData={  Value:[9.0, 10.0], BGColor:"rgba(125, 212, 251,0.5)", Position:[0, 1 ] }
                    data.Frame.CustomHorizontalInfo.push(info);

                }
            }

            this.OnSize=function(option)  //自适应大小调整
            {
                var height= $(window).height()-38;  // 38px = #PeriodTab height
                var width = $(window).width();

                this.DivKLine.style.top='0px';
                this.DivKLine.style.left='0px';
                //this.DivKLine.style.width=width+'px';
                this.DivKLine.style.height=height+'px';
                //this.Chart.OnSize(option);
            }

            // 动态网格密度：根据子帧像素高度自动调节横向格线数
            this.OnSizeFrame=function(event, data, obj)
            {
                if (!data || !data.SubFrame) return;
                var TARGET_CELL_PX = 45; // 目标每格约 45px，贴近 TradingView 视觉密度
                for (var i=0; i<data.SubFrame.length; i++)
                {
                    var frame = data.SubFrame[i].Frame;
                    if (!frame || !frame.ChartBorder || !frame.YSplitOperator) continue;
                    var chartH = frame.ChartBorder.GetChartHeight();
                    if (!chartH || chartH<=0) continue;
                    var ideal = Math.round(chartH / TARGET_CELL_PX);
                    // 限制在合理范围，避免过密/过疏
                    frame.YSplitOperator.SplitCount = Math.max(4, Math.min(20, ideal));
                }
            }

            this.ChangeSymbol=function(symbol)
            {
                if (this.Chart) this.Chart.ChangeSymbol(symbol);
            }

            this.OverlayIndex=function()
            {
                var option={WindowIndex:0, IndexName:"指标ID", Name:"自定义指标", Args:[{Name:"T", Value:5}],
                Script:"T:MA(O,20);DRAWTEXT_LINE(O>C,13,'13.00',RGB(0,33,3), 10,1, RGB(0,255,0));", Identify:"guid_66990"};
                //var option={WindowIndex:0, IndexName:"MACD", Identify:"guid_66990"};
                this.Chart.AddOverlayIndex(option);
            }

            this.ChangeIndex=function(windowIndex,indexName,option)
            {
                this.Chart.ChangeIndex(windowIndex,indexName,option);
            }

            this.AddIndexWindow=function(indexName)
            {
                this.Chart.AddIndexWindow(indexName);
            }

            this.ExecuteScriptError=function(error)
            {
                var log=`错误:${error.Description}\r\n行号:${error.LineNumber}`;
                if (error.Word) log+="\r\n错误单词:"+error.Word;

                alert(log);
                console.log('[ComplierError]', error);
            }

            this.GetIndexInfo=function()
            {
                //指标名称
                var indexName=document.getElementById('index_name').value;
                var code=this.IndexEdit.getValue();

                var PARAM_LIST=
                [
                    {Name:"param_name", Value:"param_value"},
                    {Name:"param_name_1", Value:"param_value_1"},
                    {Name:"param_name_2", Value:"param_value_2"},
                    {Name:"param_name_3", Value:"param_value_3"}
                ];

                //指标参数
                var aryParam=[];
                for(var i=0;i<PARAM_LIST.length;++i)
                {
                    var item=PARAM_LIST[i];
                    var paramName=document.getElementById(item.Name).value;
                    var value=document.getElementById(item.Value).value;

                    if (paramName && value)
                        aryParam.push({Name:paramName, Value:parseInt(value)});
                }


                var excludeYValue=document.getElementById("exclude_y").checked;

                var  indexInfo=
                {
                    Name:indexName,
                    Script:code,
                    Args:aryParam,

                    YAxis:{ ExcludeValue:excludeYValue }
                };

                return indexInfo;
            }

            //执行指标
            this.ExecuteIndexScript=function()
            {
                var indexInfo=this.GetIndexInfo();
                var windowIndex=parseInt(document.getElementById('window_index').value);

                this.Chart.ChangeScriptIndex(windowIndex,indexInfo)
            }

            this.AddScriptIndexWindow=function()
            {
                var indexInfo=this.GetIndexInfo();

                this.Chart.AddScriptIndexWindow(indexInfo)

                this.UpdateWindowsSelectDOM();

            }

            //叠加指标
            this.ExecuteOverlayIndexScript=function()
            {
                var indexInfo=this.GetIndexInfo();
                var windowIndex=parseInt(document.getElementById('window_index').value);
                var value=document.getElementById("overlay_y").checked;

                var option={ Script:indexInfo.Script, WindowIndex:windowIndex, Name:indexInfo.Name, Args:indexInfo.Args, IsShareY:!value };
                if (option.IsShareY)
                {
                    option.YAxis=indexInfo.YAxis;
                }

                this.Chart.AddOverlayIndex(option);
            }

             //语法检测
            this.CheckIndexScript=function()
            {
                var indexInfo=this.GetIndexInfo();

                var option=
                {
                    Callback:(data)=>
                    {
                        console.log("[Explain] data ", data);

                        // ── Split results into two streams ──────────────────
                        // Type === 0 → computed variable value  → 测试结果
                        // Type !== 0 → draw / semantic command  → 动态翻译
                        var testLines  = [];
                        var xlateLines = [];

                        for (var i=0; i<data.length; ++i)
                        {
                            var item=data[i];
                            if (item.Type===0)
                                testLines.push(item.Data);
                            else
                                xlateLines.push(item.Draw);

                            if (i>30)
                            {
                                testLines.push('......');
                                xlateLines.push('......');
                                break;
                            }
                        }

                        // ── 测试结果 tab — computation values ───────────────
                        var testOut=document.getElementById('fep-test-output');
                        if (testOut)
                        {
                            testOut.className='ok';
                            testOut.textContent='✓ Syntax OK\n\n'+(testLines.join('\n') || '(no computed values)');
                        }

                        // ── 动态翻译 tab — semantic / draw interpretation ───
                        var xlateOut=document.getElementById('fep-xlate-output');
                        if (xlateOut)
                            xlateOut.innerHTML=xlateLines.join('\n') || '(no draw commands)';

                        // Auto-switch to 动态翻译 so the user sees semantics
                        fepSwitchTab('xlate');
                    },

                    Arguments: indexInfo.Args,
                };

                JSComplier.Explain(indexInfo.Script, option, (error)=>
                {
                    console.log("[Explain] error", error);
                    var msg=`语法错误: 行号 ${error.LineNumber} — ${error.Description}`;

                    // ── 测试结果 tab — show error in red, no alert ──────────
                    var testOut=document.getElementById('fep-test-output');
                    if (testOut)
                    {
                        testOut.className='err';
                        testOut.textContent='✗ '+msg;
                    }

                    // Clear translation panel on error
                    var xlateOut=document.getElementById('fep-xlate-output');
                    if (xlateOut) xlateOut.innerHTML='';

                    fepSwitchTab('test');
                });
            }


            //本地指标
            this.LoadLocalIndex=function()
            {
                var cache=localStorage.getItem("TKChart_Local_Index");
                if (typeof(cache) != "string") return;

                var saveData=JSON.parse(cache);
                if (!IFrameSplitOperator.IsNonEmptyArray(saveData)) return;

                var mapIndex=new Map();
                for(var i=0;i<saveData.length;++i)
                {
                    var item=saveData[i];
                    mapIndex.set(item.Key, item.Data);
                }

                this.MapIndex=mapIndex;

                this.UpdateIndexList();
            }

            this.SaveLocalIndex=function()
            {
                var indexInfo=this.GetIndexInfo();
                var windowIndex=parseInt(document.getElementById('window_index').value);
                indexInfo.WindowIndex=windowIndex;

                if (!indexInfo.Script)
                {
                    alert("指标脚本不能为空!");
                    return;
                }

                if (this.MapIndex.has(indexInfo.Name))
                {
                    if (!window.confirm(`是否覆盖指标[${indexInfo.Name}]`)) return;
                }

                this.MapIndex.set(indexInfo.Name, indexInfo);

                this.UpdateIndexList();

                this.localStorageSave();
            }

            this.localStorageSave=function()
            {
                var aryIndex=[];
                for(var mapItem of this.MapIndex)
                {
                    var key=mapItem[0];
                    var value=mapItem[1];
                    var item={ Key:key, Data:value};
                    aryIndex.push(item);
                }

                var strData=JSON.stringify(aryIndex);
                localStorage.setItem("TKChart_Local_Index",strData);
            }

            this.UpdateIndexList=function()
            {
                var strData="";
                for(var mapItem of this.MapIndex)
                {
                    var key=mapItem[0];
                    var value=mapItem[1];

                    var strItem=`<li onclick="SelectLocalIndex(event, '${key}')">${key}<span onclick="DeleteLocalIndex(event, '${key}')">删除</span></li>`;

                    strData+=strItem;
                }

                document.getElementById('local_index').innerHTML=strData;
            }


            this.DeleteLocalIndex=function(e, name)
            {
                e.stopPropagation();
                if (!this.MapIndex.has(name)) return;

                if (!window.confirm(`是否删除指标[${name}]`)) return;

                this.MapIndex.delete(name);

                this.UpdateIndexList();

                this.localStorageSave();
            }

            this.SelectLocalIndex=function(e, name)
            {
                if (!this.MapIndex.has(name)) return;
                var item=this.MapIndex.get(name);

                this.IndexEdit.setValue(item.Script);
                document.getElementById('index_name').value=item.Name;

                var PARAM_LIST=
                [
                    {Name:"param_name", Value:"param_value"},
                    {Name:"param_name_1", Value:"param_value_1"},
                    {Name:"param_name_2", Value:"param_value_2"},
                    {Name:"param_name_3", Value:"param_value_3"}
                ];

                //指标参数
                var aryParam=[];
                for(var i=0;i<PARAM_LIST.length;++i)
                {
                    var paramItem=PARAM_LIST[i];
                    var argItem=item.Args[i];
                    if (argItem)
                    {
                        document.getElementById(paramItem.Name).value=argItem.Name;
                        document.getElementById(paramItem.Value).value=argItem.Value;
                    }
                    else
                    {
                        document.getElementById(paramItem.Name).value="";
                        document.getElementById(paramItem.Value).value="";
                    }

                }

                document.getElementById('window_index').value=item.WindowIndex;
            }


            this.SplashScreen=function(enable)
            {
                this.Chart.EnableSplashScreen(enable);
            }

            this.ChangeStyle=function(styleName)
            {
                // TradingView 统一颜色与字体（切换皮肤时保持不变）
                var TV_UP   = '#089981';
                var TV_DOWN = '#f23645';
                var TV_FONT = GetDevicePixelRatio() * 12 + 'px "Trebuchet MS", Arial, sans-serif';

                var buttonColor=[null,null];
                if (styleName=='black')
                {
                    var style=TKChartStyle.GetStyleConfig(STYLE_TYPE_ID.BLACK_ID);

                    // TradingView 深色主题覆盖
                    style.BGColor             = '#131722';
                    style.FrameBorderPen      = 'rgba(42,46,57,0.8)';
                    style.FrameSplitPen       = 'rgba(200,200,200,0.25)';
                    style.FrameSplitTextColor = '#707481';  // 坐标轴刻度色
                    style.DefaultTextColor    = '#d1d4dc';
                    style.FrameTitleBGColor   = '#131722';
                    style.UpBarColor          = TV_UP;
                    style.DownBarColor        = TV_DOWN;
                    style.DefaultTextFont           = TV_FONT;
                    style.FrameSplitTextFont        = TV_FONT;
                    style.TitleFont                 = TV_FONT;
                    if (!style.OverlayFrame) style.OverlayFrame={};
                    style.OverlayFrame.TitleFont    = TV_FONT;
                    style.CorssCursorTextFont       = TV_FONT;

                    buttonColor[0]="rgb(156,156,156)";
                    buttonColor[1]="rgb(255,255,255)";

                    JSChart.SetCSSStyle(STYLE_TYPE_ID.BLACK_ID);
                }
                else if (styleName=='white')
                {
                    var style=TKChartStyle.GetStyleConfig(STYLE_TYPE_ID.WHITE_ID);

                    // TradingView 浅色主题覆盖
                    style.BGColor             = '#ffffff';
                    style.FrameBorderPen      = 'rgba(240,243,250,1)';
                    style.FrameSplitPen       = 'rgba(240,243,250,1)';  // = #f0f3fa TradingView 官方浅色网格
                    style.FrameSplitTextColor = '#787b86';  // TV 浅色坐标轴刻度色
                    style.DefaultTextColor    = '#131722';
                    style.FrameTitleBGColor   = '#ffffff';
                    style.UpBarColor          = TV_UP;
                    style.DownBarColor        = TV_DOWN;
                    style.DefaultTextFont           = TV_FONT;
                    style.FrameSplitTextFont        = TV_FONT;
                    style.TitleFont                 = TV_FONT;
                    if (!style.OverlayFrame) style.OverlayFrame={};
                    style.OverlayFrame.TitleFont    = TV_FONT;
                    style.CorssCursorTextFont       = TV_FONT;

                    buttonColor[0]="rgb(156,156,156)";
                    buttonColor[1]="rgb(105,105,105)";

                    JSChart.SetCSSStyle(STYLE_TYPE_ID.WHITE_ID);
                }
                else
                {
                    return;
                }

                var penBorder=style.FrameBorderPen;
                var frame=this.Chart.JSChartContainer.Frame;
                for(var i=0, j=0;i<frame.SubFrame.length;++i)
                {
                    var subFrame=frame.SubFrame[i];
                    for(j=0;j<subFrame.Frame.CustomToolbar.length;++j)
                    {
                        var item=subFrame.Frame.CustomToolbar[j];
                        if (item.ID=="8888" || item.ID=="8889")
                        {
                            item.Style.MoveOnColor=buttonColor[1];
                            item.Style.Color=buttonColor[0];
                        }
                    }

                    var frameItem=subFrame.Frame;
                    frameItem.YLineExtend=[{ Width:5, Color:penBorder}, { Width:5, Color:penBorder}];
                    frameItem.XLineExtend=[{ Mode:1, Color:penBorder}];

                    for(var j=0;j<subFrame.OverlayIndex.length;++j)
                    {
                        var overlayItem=subFrame.OverlayIndex[j];
                        var overlayFrame=overlayItem.Frame;
                        overlayFrame.PenBorder=penBorder;

                        for(var k=0;k<overlayFrame.CustomToolbar.length;++k)
                        {
                            var item=overlayFrame.CustomToolbar[k];
                            if (item.ID=="8889")
                            {
                                item.Style.MoveOnColor=buttonColor[1];
                                item.Style.Color=buttonColor[0];
                            }
                        }
                    }
                }

                style.ToolbarButtonStyle=1;
                style.OverlayFrame.BolderPen=style.FrameBorderPen;
                JSChart.SetStyle(style);
                // 同步网格线 Dash 模式：深色=虚线，浅色=实线
                var res = JSChart.GetResource();
                res.FrameYLineDash = (styleName==='black') ? [1,1] : null;  // 横向虚线（细密）
                res.FrameXLineDash = (styleName==='black') ? [1,1] : null;  // 纵向虚线（细密）
                this.DivKLine.style.backgroundColor=style.BGColor;

                this.Chart.ReloadResource({ Resource:null, Draw:true, Update:true });
            }

            this.OnTitleDraw=function(event, data, obj)
            {
                console.log("[KLineChart::OnTitleDraw] data=", data);
            }

            this.OnClickExtendChartButton=function(event, data, obj)
            {
                console.log("[KLineChart::OnClickExtendChartButton] data=", data);

                if (!data.Info) return;

                if (this.OnClickIndexButton(data.Info, data.e, obj))
                {
                    data.PreventDefault=true;
                }
            }


            this.OnClickIndexButton=function(btnInfo, e, tkchart)
            {
                if (btnInfo.Chart.ClassName!="FrameButtomToolbarPaint") return false;

                var chart=btnInfo.Chart;
                var data=btnInfo.Data;
                if (!data.Data) return;

                var windowIndex=btnInfo.FrameID;
                if (btnInfo.ButtonType==0 && data.Data.IndexID)
                {
                    var indexID=data.Data.IndexID;
                    chart.SetSelectedID(data.ID);
                    this.Chart.ChangeIndex(windowIndex, indexID);
                    return;
                }

                if (btnInfo.ID=="F_BTN_07")
                {
                    var tabInfo={ID:"F_BTN_07", Chart:chart };
                    var menuData=
                    {
                        Menu:
                        [
                            { Name:"ACD", ID:"POP_MENU_1", Data:{ IndexID:"ACD", WindowIndex:btnInfo.FrameID, TabInfo:tabInfo } },
                            { Name:"AMV", ID:"POP_MENU_2", Data:{ IndexID:"AMV", WindowIndex:btnInfo.FrameID, TabInfo:tabInfo } },
                            { Name:"BIAS", ID:"POP_MENU_3", Data:{ IndexID:"BIAS", WindowIndex:btnInfo.FrameID, TabInfo:tabInfo } },
                            {
                                Name:"其他指标",
                                SubMenu:
                                [
                                    { Name:"WAD", Data:{ IndexID:"WAD", WindowIndex:btnInfo.FrameID, TabInfo:tabInfo }},
                                    { Name:"MASS", Data:{ IndexID:"MASS", WindowIndex:btnInfo.FrameID, TabInfo:tabInfo }}
                                ]
                            }
                        ],

                        Position:JSPopMenu.POSITION_ID.TAB_MENU_ID,

                        ClickCallback:(data)=>{ this.OnClickIndexMenu(data); }
                    };

                    this.Chart.PopupMenuByTab(menuData, btnInfo.RectCell);

                    if(e.preventDefault) e.preventDefault();
                    if(e.stopPropagation) e.stopPropagation();
                }
                else if (btnInfo.ID=="F_BTN_08")
                {
                    if(e.preventDefault) e.preventDefault();
                    if(e.stopPropagation) e.stopPropagation();

                    tkchart.ShowAddIndexWindowDialog({ });
                }


                return true;
            }

            this.OnClickIndexMenu=function(menuData)
            {
                if (!menuData.Data) return;
                var data=menuData.Data;
                var windowIndex=data.WindowIndex;
                var indexID=data.IndexID;
                if (data.TabInfo)
                {
                    var chart=data.TabInfo.Chart;
                    for(var i=0;i<chart.AryButton.length;++i)
                    {
                        var item=chart.AryButton[i];
                        if (item.ID==data.TabInfo.ID)
                        {
                            item.Data={ IndexID:indexID };
                            item.Title=menuData.Name;
                            item.TooltipText=`指标${item.Title}说明: xxxxxx`;
                            break;
                        }
                    }
                }

                this.Chart.ChangeIndex(windowIndex, indexID);
            }

            this.OnChangeIndex=function(event, data, obj)
            {
                console.log("[KLineChart::OnChangeIndex] data=", data);

                var aryChart=obj.GetExtendChartByClassNameV2("FrameButtomToolbarPaint");
                if (!IFrameSplitOperator.IsNonEmptyArray(aryChart)) return;

                var windowIndex=data.WindowIndex;
                var indexID=data.IndexInfo.ID;
                for(var i=0;i<aryChart.length;++i)  //工具栏联动
                {
                    var item=aryChart[i];
                    var chart=item.Chart;
                    if (chart.FrameID==windowIndex)
                    {
                        var finder=null;
                        for(var j=0;j<chart.AryButton.length;++j)
                        {
                            var btnItem=chart.AryButton[j];
                            if (btnItem.Data && btnItem.Data.IndexID==indexID)
                            {
                                finder=btnItem;
                                break;
                            }
                        }

                        if (finder) chart.SetSelectedID(finder.ID);
                        else chart.SetSelectedID(null);

                        return;
                    }
                }
            }

            this.OnClickTitleButton=function(event, data, obj)
            {
                console.log("[KLineChart::OnClickTitleButton] data=", data);

                if (!data.Info || !data.Info.Data) return;
                var rtButton=data.Info.Rect;
                var e=data.e;
                if (data.Info.ID==8889)
                {
                    var menuData=
                    {
                        Menu:
                        [
                            this.Chart.JSChartContainer.GetModifyOverlayIndexMenuData(data.Info.Data.IndexGuid),
                            this.Chart.JSChartContainer.GetShowOverlayIndexMenuData(data.Info.Data.IndexGuid),
                            this.Chart.JSChartContainer.GetShowOverlayIndexYAxisMenuData(data.Info.Data.IndexGuid),
                            this.Chart.JSChartContainer.GetOverlayIndexShareYMenuData(data.Info.Data.IndexGuid),
                            { Name:JSPopMenu.SEPARATOR_LINE_NAME },
                            { Name:"删除指标",  Data:{ ID: JSCHART_MENU_ID.CMD_DELETE_OVERLAY_INDEX_ID, Args:[data.Info.Data.IndexGuid] } },
                        ],

                        Position:JSPopMenu.POSITION_ID.TAB_MENU_ID,

                        ClickCallback:(data)=>{ this.OnClickIndexDrapdownMenu(data); }
                    };
                }
                else
                {
                    var menuItem=this.Chart.JSChartContainer.GetShowIndexMenuData(data.Info.FrameID);
                    var modifyMenu=this.Chart.JSChartContainer.GetModifyIndexMenuData(data.Info.FrameID);
                    var frame=this.Chart.JSChartContainer.Frame.SubFrame[data.Info.FrameID].Frame;

                    var menuData=
                    {
                        Menu:
                        [
                            modifyMenu,
                            menuItem,
                            {
                                Name:"Y轴分割方式",
                                SubMenu:
                                [
                                    { Name:"自动", Data:{ ID:"CHANGE_Y_SPLIT_TYPE", Args:[data.Info.FrameID, 0] }, Checked:frame.YSplitOperator.SplitType===0 },
                                    { Name:"数值最大最小", Data:{ ID:"CHANGE_Y_SPLIT_TYPE", Args:[data.Info.FrameID, 1] },Checked:frame.YSplitOperator.SplitType===1  },
                                ]
                            },
                            { Name:"设置2",  Data:{ ID:"INDEX_DRAPDOWN_MENU_2", WindowIndex:data.Info.FrameID } },
                        ],

                        Position:JSPopMenu.POSITION_ID.TAB_MENU_ID,

                        ClickCallback:(data)=>{ this.OnClickIndexDrapdownMenu(data); }
                    };
                }

                this.Chart.PopupMenuByDrapdown(menuData, rtButton);

                if(e.preventDefault) e.preventDefault();
                if(e.stopPropagation) e.stopPropagation();
            }

            this.OnClickIndexDrapdownMenu=function(menuData)
            {
                if (menuData.Data.ID==JSCHART_MENU_ID.CMD_SHOW_INDEX_ID || menuData.Data.ID==JSCHART_MENU_ID.CMD_SHOW_OVERLAY_INDEX_ID ||
                    menuData.Data.ID==JSCHART_MENU_ID.CMD_DELETE_OVERLAY_INDEX_ID || menuData.Data.ID==JSCHART_MENU_ID.CMD_SHOW_OVERLAY_Y_AXIS_ID ||
                    menuData.Data.ID==JSCHART_MENU_ID.CMD_ENABLE_OVERLAY_SHARE_Y_ID ||
                    menuData.Data.ID==JSCHART_MENU_ID.CMD_MODIFY_INDEX_PARAM || menuData.Data.ID==JSCHART_MENU_ID.CMD_MODIFY_OVERLAY_INDEX_PARAM )
                {
                    this.Chart.JSChartContainer.ExecuteMenuCommand(menuData.Data.ID, menuData.Data.Args);
                }
                else if (menuData.Data.ID=="CHANGE_Y_SPLIT_TYPE")
                {
                    var frameID=menuData.Data.Args[0];
                    var frame=this.Chart.JSChartContainer.Frame.SubFrame[frameID].Frame;
                    frame.YSplitOperator.SplitType=menuData.Data.Args[1];
                    this.Chart.JSChartContainer.ResetFrameXYSplit();
                    this.Chart.JSChartContainer.Draw();
                }
                else
                {
                    console.log("[KLineChart::OnClickIndexDrapdownMenu] menuData=", menuData);

                    var text=`指标下拉菜单\r\n窗口:${menuData.Data.WindowIndex}\r\n菜单ID:${menuData.Data.ID}`;
                    alert(text);
                }

            }

            this.ColorCount=0;
            this.ClickCrossCursor=function(event, data, obj)
            {
                console.log('[KLineChart::ClickCrossCursor] event, data', event , data); //打印信息

                var button=data.Button;
                var rtButton=button.Rect;
                var yValue=button.Data.YValue;
                var windowIndex=button.Data.FrameID;
                var e=data.e;

                if (windowIndex==0)
                {
                    var menuData=
                    {
                        Menu:
                        [
                            { Name:`买入 @ ${yValue.toFixed(2)}`,  Data:{ ID: "MENU_BUY_ID",  Args:[yValue] } },
                            { Name:`卖出 @ ${yValue.toFixed(2)}`,  Data:{ ID: "MENU_SELL_ID", Args:[yValue] } },
                            { Name:JSPopMenu.SEPARATOR_LINE_NAME },
                            { Name:`画线 @ ${yValue.toFixed(2)}`,  Data:{ ID: "MENU_DRAW_LINE_ID", Args:[yValue, windowIndex] } },
                        ],

                        Position:JSPopMenu.POSITION_ID.DROPDOWN_RIGHT_MENU_ID,

                        ClickCallback:(data)=>{ this.OnClickCrossCursorMenu(data); }
                    };
                }
                else
                {
                    var menuData=
                    {
                        Menu:
                        [
                            { Name:`画线 @ ${yValue.toFixed(5)}`,  Data:{ ID: "MENU_DRAW_LINE_ID", Args:[yValue, windowIndex] } },
                        ],

                        Position:JSPopMenu.POSITION_ID.DROPDOWN_RIGHT_MENU_ID,

                        ClickCallback:(data)=>{ this.OnClickCrossCursorMenu(data); }
                    };

                }


                this.Chart.PopupMenuByDrapdown(menuData, rtButton);

                if(e.preventDefault) e.preventDefault();
                if(e.stopPropagation) e.stopPropagation();
            }

            this.ColorCount=0;
            this.OnClickCrossCursorMenu=function(data)
            {
                console.log("[KLineChart::OnClickCrossCursorMenu] data=", data);

                if (data.Data.ID=="MENU_DRAW_LINE_ID")
                {
                    var ARRAY_COLOR=['rgb(255,140,0)', "rgb(153,50,204)", "rgb(0, 139, 0)"];
                    var lineColor=ARRAY_COLOR[this.ColorCount%ARRAY_COLOR.length];
                    ++this.ColorCount;

                    var yValue=data.Data.Args[0];
                    var frameID=data.Data.Args[1];
                    var drawPictrue=
                    {
                        ClassName:"ChartDrawHLine",
                        Value:[ {XValue:0, YValue:yValue} ],
                        FrameID:frameID,
                        RightSpaceWidth:2,
                        Button:{ SettingIcon:null },
                        ButtonBGColor:"rgb(100,0,0)",
                        LineColor:lineColor
                    };

                    this.Chart.AddChartDrawPicture(drawPictrue);
                    this.Chart.Draw();
                }
                else if (data.Data.ID=="MENU_BUY_ID")
                {
                    var yValue=data.Data.Args[0];
                    var text=`买入价:${yValue.toFixed(2)}`;
                    alert(text);
                }
                else if (data.Data.ID=="MENU_SELL_ID")
                {
                    var yValue=data.Data.Args[0];
                    var text=`卖出价:${yValue.toFixed(2)}`;
                    alert(text);
                }
            }

            this.OnCreateRightMenu=function(event, data, obj)
            {
                console.log("[KLineChart::OnCreateRightMenu] data=", data);

                var item={ Name:"自定义菜单项", Data:{ ID:"CUSTOM_MENU_1_ID", Args:[1] } };
                data.MenuData.Menu.push( { Name:JSPopMenu.SEPARATOR_LINE_NAME });
                data.MenuData.Menu.push(item);
                var frameID=data.FrameID;
                for(var i=0;i<data.MenuData.Menu.length;++i)
                {
                    var item=data.MenuData.Menu[i];
                    if (item.Name=="其他设置")
                    {
                        for(var j=0;j<item.SubMenu.length;++j)
                        {
                            var subItem=item.SubMenu[j];
                            if (subItem.Name=="鼠标形状")
                            {
                                var customCursor="url('../jscommon/iyxchart.resource/Cursor/normal.cur'), default";
                                var newItem={ Name:"自定义图片", Data:{ ID:JSCHART_MENU_ID.CMD_CHANGE_DEFAULTCURSOR_ID, Args:[customCursor]}, Checked:obj.DefaultCursor==customCursor };
                                subItem.SubMenu.push(newItem);
                                break;
                            }
                        }
                    }
                    else if (item.Name=="指标切换")
                    {
                        item.SubMenu.push({ Name:JSPopMenu.SEPARATOR_LINE_NAME });
                        var indexInfo={ API: { ID:"API-DRAWTEXTREL", Name:'收盘线(后台)',Args:null, Url:'local'} };
                        var newItem={ Name:indexInfo.API.Name, Data:{ ID: JSCHART_MENU_ID.CMD_CHANGE_API_INDEX_ID, Args:[frameID, indexInfo]}};
                        item.SubMenu.push(newItem);

                        var indexInfo={ API: { ID:"API-MULTI_POINT", Name:'MULTI_POINT指标(后台)',Args:null, Url:'local'} };
                        var newItem={ Name:indexInfo.API.Name, Data:{ ID: JSCHART_MENU_ID.CMD_CHANGE_API_INDEX_ID, Args:[frameID, indexInfo]}};
                        item.SubMenu.push(newItem);

                        var indexInfo={ API: { ID:"API-DRAWCOLORKLINE", Name:'DRAWCOLORKLINE指标(后台)',Args:null, Url:'local'} };
                        var newItem={ Name:indexInfo.API.Name, Data:{ ID: JSCHART_MENU_ID.CMD_CHANGE_API_INDEX_ID, Args:[frameID, indexInfo]}};
                        item.SubMenu.push(newItem);

                        var indexInfo={ API: { ID:"API-DRAWBAND", Name:'DRAWBAND指标(后台)',Args:null, Url:'local'} };
                        var newItem={ Name:indexInfo.API.Name, Data:{ ID: JSCHART_MENU_ID.CMD_CHANGE_API_INDEX_ID, Args:[frameID, indexInfo]}};
                        item.SubMenu.push(newItem);

                        var indexInfo={ API: { ID:"API-MULTI_LINE", Name:'MULTI_LINE指标(后台)',Args:null, Url:'local'} };
                        var newItem={ Name:indexInfo.API.Name, Data:{ ID: JSCHART_MENU_ID.CMD_CHANGE_API_INDEX_ID, Args:[frameID, indexInfo]}};
                        item.SubMenu.push(newItem);


                        var indexInfo={ Name:"高低均价(自定义脚本)", ID:"HIGH_LOW_AV", Script:"均价:(H+L)/2;高:H;低:L;" };
                        var option=null;
                        var newItem={ Name:indexInfo.Name, Data:{ ID: JSCHART_MENU_ID.CMD_CHANGE_SCRIPT_INDEX_ID, Args:[frameID, indexInfo, option]}};
                        item.SubMenu.push(newItem);
                    }
                }

            }

            this.OnMenuCommand=function(event, data, obj)
            {
                console.log("[KLineChart::OnMenuCommand] data=", data);

                if (data.CommandID=="CUSTOM_MENU_1_ID")
                {
                    data.PreventDefault=true;

                    var text="外部自定义菜单按钮";
                    alert(text);
                }
            }

            this.UpdateWindowsSelectDOM=function()
            {
                if (!this.Chart.JSChartContainer) return;

                var selectDom=document.getElementById('window_index');
                selectDom.options.length=0;

                var lWindowCount=this.Chart.JSChartContainer.Frame.SubFrame.length;
                for(var i=0;i<lWindowCount;++i)
                {
                    var name=`附图-${i}`;
                    if (i==0) name="主图";

                    selectDom.add(new Option(name, i));
                }
            }


            this.ShowAllKLine=function()
            {
                this.Chart.JSChartContainer.ShowAllKLine();
            }


            this.OnRecvHistoryData=function(event, data, obj)
            {
                console.log("[KLineChart::OnRecvHistoryData] data=", data);
            }

            this.OnFormatKLineHighLowTitle=function(event, data, obj)
            {
                console.log("[KLineChart::OnFormatKLineHighLowTitle] data=", data);

                return;

                data.PreventDefault=true;
                data.Title.High+="!!"
                data.Title.HighColor="rgb(255,0,255)";
                data.Title.Low+="!!"
                data.Title.LowColor="rgb(34,139,34)";
            }

            this.OnFormatIndexOutText=function(event, data, obj)
            {
                console.log("[KLineChart::OnFormatIndexOutText] data=", data);
            }

            this.OnFormatKLineFloatTooltip=function(event, data, obj)
            {
                return;

                var aryText=data.AryText;   //显示的数据
                var kItem=data.data;        //K线数据

                var item=
                {
                    Title:"字段1",
                    Text:'99999万',
                    Color:'rgb(255,0,255)'
                };
                aryText.push(item)
            }


            this.OnCalculateChipData=function(event, data, obj)
            {
                console.log("[KLineChart::OnCalculateChipData] data=", data);
            }

            // ---- 新增：周期/筹码/画线方法 ----

            this.ChangePeriod=function(value)
            {
                if (this.Chart) this.Chart.JSChartContainer.ChangePeriod(value);
            }

            this.EnableStockChip=function()
            {
                if (!this.Chart || !this.Chart.JSChartContainer) return;
                var tkchart=this.Chart.JSChartContainer;
                var bShowStockChip=false;
                if (tkchart.GetStockChipChart()) bShowStockChip=true;
                var stockChipConfig={Name:'StockChip', ShowType:1, Width:230};
                if (bShowStockChip)
                    tkchart.ExecuteMenuCommand(JSCHART_MENU_ID.CMD_HIDE_STOCKCHIP_ID);
                else
                    tkchart.ExecuteMenuCommand(JSCHART_MENU_ID.CMD_SHOW_STOCKCHIP_ID, [stockChipConfig.Name, stockChipConfig]);
            }

            this.ShowDrawTool=function()
            {
                if (!this.Chart || !this.Chart.JSChartContainer) return;
                var tkchart=this.Chart.JSChartContainer;
                var bShow=tkchart.IsShowDrawToolDialog();
                if (!bShow) tkchart.ExecuteMenuCommand(JSCHART_MENU_ID.CMD_SHOW_DRAWTOOL_ID);
            }

            this.Hide=function()
            {
                if (this.Chart && this.Chart.JSChartContainer) this.Chart.JSChartContainer.HideAllPopDiv();
            }

            this.ReloadResource=function()
            {
                if (this.Chart) this.Chart.ReloadResource({ Resource:null, Draw:true, Update:true });
            }
        }


        KLineChart.InitalStyle=function()
        {
            var blackStyle=TKChartStyle.GetStyleConfig(STYLE_TYPE_ID.BLACK_ID); //读取黑色风格配置
            JSChart.SetStyle(blackStyle);
            var resource=JSChart.GetResource();

            resource.BGColor=blackStyle.BGColor;
            resource.ToolbarButtonStyle=1;
            resource.FrameYLineDash=[2,2];
            resource.FrameXLineDash=[1,1]; // 竖向网格线初始虚线（细密）
            resource.UpBarColor='rgb(248,41,71)';
            resource.DownBarColor='rgb(84,255,255)';
            resource.Frame.XBottomOffset=4;
            resource.IndexTitleMerginLeft=3*GetDevicePixelRatio();
            resource.DOTLINE.LineDash=[10,10];
            //resource.IndexTitle.ArrowType=1;
            resource.IndexTitle.EnableIndexArrow=false;
            JSChart.SetCSSStyle(STYLE_TYPE_ID.BLACK_ID);
        }


        // ---- 分时图控件 ----
        function MinuteChart(divKLine)
        {
            this.DivKLine=divKLine;
            this.Chart=JSChart.Init(divKLine, false, false);   //把分时图绑定到一个Div上

            //分时图配置
            this.Option= {
                Type:'分钟走势图',   //创建图形类型

                Windows: //窗口指标
                [
                    //{ Index:"AMO", YAxis:{StringFormat:1} },
                    { Index:"MACD", AddIndexWindow:true, IsSync:true, IndexHelp:true, },

                ],

                OverlayIndex:
                [

                ],  //叠加指标

                Symbol:'600000.sh',
                IsAutoUpdate:true,          //是自动更新数据
                AutoUpdateFrequency:1000,   //数据更新频率
                DayCount:1,                 //1 最新交易日数据 >1 多日走势图
                IsShowRightMenu:true,       //是否显示右键菜单

                LatestPointFlash:{ Enable:true, Frequency:500 },

                DragSelectRect:
                {
                    Enable:true,
                    EnableLButton:true,
                },

                EnableZoomIndexWindow:true,

                EnablePopMenuV2:true,
                EnableDrawToolDialogV2:true,
                EnableNewIndex:true,
                TooltipDialog:{ Enable:false, Style:1 },
                EnableResize:true,
                Minute:{ DragMode:1, },

                MaxDayCount:5,

                CorssCursorInfo:
                {
                    HPenType:1, VPenType:1,
                    Left:1, Right:1, Bottom:1,
                    RightButton:{ Enable:true },
                    EnableDBClick:true,
                },


                SelectRect:
                {
                    ShowRangeText:{ Enable:true, Position:1 },
                },

                SelectRectDialog:{ Enable:true },

                EnableYDrag:
                {
                    Right:true,
                    Left:true,
                    Wheel:true,
                },

                MinuteLine:
                {
                    IsDrawAreaPrice:true,      //是否画价格面积图
                },

                MinuteTitle:
                {
                    IsShowTime:true,
                    IsShowName:true,
                    IsShowDate:false,
                    IsShowVolTitle:true,
                    IsTitleShowLatestData:true,
                },

                MinuteVol:
                {
                    BarColorType:1,
                },

                IsDrawPictureXY:true,

                SelectedChart:{ EnableSelected: true, EnableMoveOn:true },
                EnableIndexChartDrag:true,

                FloatTooltip:{ Enable:true, },
                SearchIndexDialog:{ Enable:true },
                ModifyIndexParamDialog:{ Enable:true },

                EnableNightDayBG:true,

                Border: //边框
                {
                    Left:20,    //左边间距
                    Right:20,   //右边间距
                    Top:25,
                    Bottom:25,

                    AutoLeft:{ Blank:10, MinWidth:60 },
                    AutoRight:{ Blank:10, MinWidth:60 },
                },

                Frame:  //子框架设置
                [
                    {
                        Custom:
                        [
                            {
                                Type:0,  Position:'right',
                            }
                        ]
                    },
                ],

                Overlay:    //叠加股票
                [
                ],

                ExtendChart:    //扩展图形
                [
                    {Name:'MinutePCTooltip' }, //PC端tooltip
                ]
            };


            this.Create=function()  //创建图形
            {
                var self=this;
                $(window).resize(function() { self.OnSize(); });    //绑定窗口大小变化事件

                this.Option.ScriptError=(error)=> { this.ExecuteScriptError(error); }
                this.Option.NetworkFilter=(data, callback)=>{ this.NetworkFilter(data, callback); }

                this.Option.EventCallback=
                [

                ];

                this.Chart.SetOption(this.Option);  //设置分时图配置
                this.OnSize();  //初始化尺寸
            }

            this.ExecuteScriptError=function(error)
            {
                var log=`错误:${error.Description}\r\n���号:${error.LineNumber}`;
                if (error.Word) log+="\r\n错误单词:"+error.Word;
                alert(log);
            }

            this.NetworkFilter=function(data, callback)
            {
                console.log(`[MinuteChart::NetworkFilter] ${HQData.Explain}`, data);

                switch(data.Name)
                {
                    default:
                        HQData.NetworkFilter(data, callback);
                        break;
                }
            }


            this.OnSize=function(option)  //自适应大小调整
            {
                var height= $(window).height()-38;  // 38px = #PeriodTab height
                this.DivKLine.style.height=height+'px';
                //this.Chart.OnSize(option);
            }

            this.ChangeSymbol=function(symbol)
            {
                if (this.Chart) this.Chart.ChangeSymbol(symbol);
            }

            this.Hide=function()
            {
                if (this.Chart && this.Chart.JSChartContainer) this.Chart.JSChartContainer.HideAllPopDiv();
            }

            this.ChangeDayCount=function(count)
            {
                if (this.Chart) this.Chart.JSChartContainer.ChangeDayCount(count);
            }

            this.ReloadResource=function()
            {
                if (this.Chart) this.Chart.ReloadResource({ Resource:null, Draw:true, Update:true });
            }

            this.ShowDrawTool=function()
            {
                if (!this.Chart || !this.Chart.JSChartContainer) return;
                var tkchart=this.Chart.JSChartContainer;
                var bShow=tkchart.IsShowDrawToolDialog();
                if (!bShow) tkchart.ExecuteMenuCommand(JSCHART_MENU_ID.CMD_SHOW_DRAWTOOL_ID);
            }

            this.EnableBeforeOpen=function()
            {
                if (!this.Chart || !this.Chart.JSChartContainer) return;
                var tkchart=this.Chart.JSChartContainer;
                var bShow=tkchart.IsShowBeforeData && tkchart.IsShowMultiDayBeforeData;
                var data={ Left:!bShow, MultiDay:{ Left:!bShow }};
                tkchart.ExecuteMenuCommand(JSCHART_MENU_ID.CMD_SHOW_CALLCATION_ID,[data]);
            }
        }


        // ---- 周期Tab切换函数 ----

        function setActiveTab(id)
        {
            var old=document.getElementById(g_activeTabId);
            if (old) old.classList.remove('active');
            g_activeTabId=id;
            var el=document.getElementById(id);
            if (el) el.classList.add('active');

            // 根据当前是K线还是分时，显示/隐藏 筹码/竞价 按钮
            var stockChipDom=document.getElementById('StockChip');
            var beforeOpenDom=document.getElementById('BeforeOpen');
            if (stockChipDom) stockChipDom.style.display=g_isKLine?'inline-flex':'none';
            if (beforeOpenDom) beforeOpenDom.style.display=g_isKLine?'none':'inline-flex';
        }

        function showKLine(period)
        {
            g_isKLine=true;
            document.getElementById('KLine').style.display='block';
            document.getElementById('Minute').style.display='none';
            if (minuteControl) minuteControl.Hide();
            if (klineControl)
            {
                klineControl.Hide();
                klineControl.ChangePeriod(period);
            }
        }

        function showMinute(dayCount)
        {
            g_isKLine=false;
            document.getElementById('Minute').style.display='block';
            document.getElementById('KLine').style.display='none';
            if (klineControl) klineControl.Hide();
            if (minuteControl) minuteControl.ChangeDayCount(dayCount);
        }


        function DeleteLocalIndex(e, name)
        {
            alert(`[DeleteLocalIndex]${name}`);
            e.stopPropagation();
        }

        function SelectLocalIndex(e, name)
        {
            alert(`[SelectLocalIndex]${name}`);
        }

        $(function ()
        {
            const font = new FontFace("iconfont",`url('../jscommon/iyxchart.resource/font/iconfont.woff?t=1690947130935') format('woff')`);
            document.fonts.add(font);    //把字体添加到 document.font（FontFaceSet）中
            font.load();    // 加载字体

            KLineChart.InitalStyle();

            klineControl=new KLineChart(document.getElementById('kline'));
            minuteControl=new MinuteChart(document.getElementById('MinuteCtrl'));

             // 等待到所有的字体都加载完毕
             document.fonts.ready.then(() =>
            {
                klineControl.Create();
                minuteControl.Create();
            });

            klineControl.LoadLocalIndex();

            var jsEditor;
            $('#tools_code').val(DEFAULT_CODE);
            jsEditor = CodeMirror.fromTextArea($('#tools_code').get(0), {
                mode: "iyx-formula",
                lineNumbers: true,
                indentWithTabs: false,
                tabSize: 4,
                theme: 'fep-dark',   // matched by CSS overrides below
                extraKeys: {
                    'F5':         function() { klineControl.ExecuteIndexScript(); },
                    'Ctrl-Enter': function() { klineControl.ExecuteIndexScript(); }
                }
            });
            jsEditor.setSize('100%', '100%');

            klineControl.IndexEdit=jsEditor;


            var hqKeyboard=new JSPopKeyboard();

            // ---- 周期 Tab 点击绑定 ----
            document.getElementById('MinuteDay').onmousedown=(e)=>{ showMinute(1); setActiveTab('MinuteDay'); };
            document.getElementById('Minute5Day').onmousedown=(e)=>{ showMinute(5); setActiveTab('Minute5Day'); };
            document.getElementById('KLineDay').onmousedown=(e)=>{ showKLine(0); setActiveTab('KLineDay'); };
            document.getElementById('KLineWeek').onmousedown=(e)=>{ showKLine(1); setActiveTab('KLineWeek'); };
            document.getElementById('KLineMonth').onmousedown=(e)=>{ showKLine(2); setActiveTab('KLineMonth'); };
            document.getElementById('KLineYear').onmousedown=(e)=>{ showKLine(3); setActiveTab('KLineYear'); };
            document.getElementById('KLineMinute').onmousedown=(e)=>{ showKLine(4); setActiveTab('KLineMinute'); };
            document.getElementById('KLine5Minute').onmousedown=(e)=>{ showKLine(5); setActiveTab('KLine5Minute'); };
            document.getElementById('KLine15Minute').onmousedown=(e)=>{ showKLine(6); setActiveTab('KLine15Minute'); };
            document.getElementById('KLine30Minute').onmousedown=(e)=>{ showKLine(7); setActiveTab('KLine30Minute'); };

            document.getElementById('StockChip').onmousedown=(e)=>{ klineControl.EnableStockChip(); };
            document.getElementById('BeforeOpen').onmousedown=(e)=>{ minuteControl.EnableBeforeOpen(); };
            document.getElementById('DrawTool').onmousedown=(e)=>
            {
                if (g_isKLine) klineControl.ShowDrawTool();
                else minuteControl.ShowDrawTool();
            };

            document.getElementById('LangBtn').onmousedown=(e)=>{ switchLanguage(); };

            // 顶部皮肤循环切换按钮（SVG 图标）
            var SVG_SUN  = '<svg width="18" height="18" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 18a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" fill="currentColor"/><path fill-rule="evenodd" clip-rule="evenodd" d="M14 4.5V3h-1v1.5h1zM8.7 5.76l-1.06-1.06-.7.71 1.06 1.06.7-.7zM19.3 5.76l1.06-1.06.7.71-1.06 1.06-.7-.7zM4.5 13v1H3v-1h1.5zM21 13v1h1.5v-1H21zM5.76 19.3l-1.06 1.06.71.7 1.06-1.06-.7-.7zM18.24 19.3l1.06 1.06.7-.71-1.06-1.06-.7.7zM14 19.5V21h-1v-1.5h1z" fill="currentColor"/></svg>';
            var SVG_MOON = '<svg width="18" height="18" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18.17 14.65c-.3.26-.63.5-.98.7-.93.53-2.02.83-3.19.83-3.59 0-6.5-2.91-6.5-6.5 0-1.17.3-2.26.83-3.19.2-.35.44-.68.7-.98a7.51 7.51 0 1 0 9.14 9.14z" fill="currentColor"/></svg>';

            document.getElementById('ThemeBtn').onmousedown=(e)=>
            {
                var nextTheme = (g_currentTheme === 'black') ? 'white' : 'black';
                g_currentTheme = nextTheme;
                klineControl.ChangeStyle(nextTheme);
                minuteControl.ReloadResource();
                hqKeyboard.ReloadResource();
                // 深色模式→太阳图标；浅色模式→月亮图标
                document.getElementById('ThemeBtn').innerHTML = (nextTheme === 'black') ? SVG_SUN : SVG_MOON;
            };

            // ---- 搜索框 ----
            document.getElementById('SearchInput').addEventListener('keydown',(e)=>
            {
                if (e.key==='Enter')
                {
                    var symbol=document.getElementById('SearchInput').value.trim();
                    if (symbol)
                    {
                        klineControl.ChangeSymbol(symbol);
                        minuteControl.ChangeSymbol(symbol);
                        hqKeyboard.Hide();
                    }
                }
            });

            document.getElementById('SearchClear').addEventListener('click',()=>
            {
                document.getElementById('SearchInput').value='';
                document.getElementById('SearchInput').focus();
            });

            // ---- 公式编辑器按钮 ----
            $("#index_run").click(function() { klineControl.ExecuteIndexScript(); } );
            $("#add_index_window").click(function() { klineControl.AddScriptIndexWindow(); } );

            $("#index_check").click(function() { klineControl.CheckIndexScript(); } );
            $("#index_save").click(function() { klineControl.SaveLocalIndex(); } );
            $("#overlayindex_run").click(function(){ klineControl.ExecuteOverlayIndexScript(); })
            $("#SplashScreen").click(function(){ klineControl.SplashScreen(true); })
            $("#SplashScreen2").click(function(){ klineControl.SplashScreen(false); })

            // 工具栏风格按钮（与顶部 Tab 按钮功能相同）
            $("#style_black").click(function()
            {
                klineControl.ChangeStyle('black');
                minuteControl.ReloadResource();
                hqKeyboard.ReloadResource();
            })
            $("#style_white").click(function()
            {
                klineControl.ChangeStyle('white');
                minuteControl.ReloadResource();
                hqKeyboard.ReloadResource();
            })

            $("#showAllKLine").click(function(){ klineControl.ShowAllKLine(); })

            DeleteLocalIndex=(e, name)=>{ klineControl.DeleteLocalIndex(e, name); }
            SelectLocalIndex=(e, name)=> { klineControl.SelectLocalIndex(e, name); }

            // ================================================================
            // Float Editor Panel — toggle, tab switching, keyboard isolation
            // ================================================================

            var fepOpen = false;

            // Switch the right-column tab (called externally by CheckIndexScript)
            window.fepSwitchTab = function(tabName)
            {
                document.querySelectorAll('.fep-tab').forEach(function(t) {
                    t.classList.toggle('active', t.dataset.tab === tabName);
                });
                document.querySelectorAll('.fep-tab-panel').forEach(function(p) {
                    p.style.display = 'none';
                });
                var panel = document.getElementById('fep-panel-' + tabName);
                if (panel) panel.style.display = 'block';
            };

            // Resize CodeMirror to fill its flex container after panel opens
            function fepResizeEditor()
            {
                var col = document.querySelector('.fep-editor-col');
                if (col && jsEditor)
                    jsEditor.setSize('100%', col.clientHeight + 'px');
            }

            // Open / close the panel
            function toggleFloatEditor()
            {
                fepOpen = !fepOpen;
                var panel  = document.getElementById('floatEditorPanel');
                var btn    = document.getElementById('btnOpenEditor');
                if (fepOpen)
                {
                    panel.style.display = 'flex';
                    btn.classList.add('active');
                    setTimeout(fepResizeEditor, 0);
                }
                else
                {
                    panel.style.display = 'none';
                    btn.classList.remove('active');
                }
            }

            // Trigger buttons
            document.getElementById('btnOpenEditor').addEventListener('click', toggleFloatEditor);
            document.getElementById('btnCloseEditor').addEventListener('click', toggleFloatEditor);

            // Tab bar switching
            document.querySelectorAll('.fep-tab').forEach(function(tab) {
                tab.addEventListener('click', function() {
                    fepSwitchTab(this.dataset.tab);
                });
            });

            // ================================================================
            // Left-edge resizer — drag to resize panel width
            // ================================================================
            (function()
            {
                var resizer = document.getElementById('fepResizer');
                var panel   = document.getElementById('floatEditorPanel');
                var startX, startW;

                resizer.addEventListener('mousedown', function(e)
                {
                    e.preventDefault();
                    startX = e.clientX;
                    startW = panel.offsetWidth;
                    resizer.classList.add('dragging');

                    function onMove(e)
                    {
                        // dragging left  = larger panel; dragging right = smaller
                        var delta = startX - e.clientX;
                        var newW  = startW + delta;
                        // clamp between min-width (260px) and max-width (85vw)
                        newW = Math.max(260, Math.min(Math.round(window.innerWidth * 0.85), newW));
                        panel.style.width = newW + 'px';
                        if (fepOpen) fepResizeEditor();
                    }

                    function onUp()
                    {
                        resizer.classList.remove('dragging');
                        document.removeEventListener('mousemove', onMove);
                        document.removeEventListener('mouseup',   onUp);
                    }

                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('mouseup',   onUp);
                });
            })();

            // Keyboard isolation — 冒泡阶段（不传 true / 默认 false）：
            // CodeMirror 先在目标阶段完整处理 keydown（Backspace / Delete / Ctrl+A 等），
            // 之后冒泡到此处再阻止传播，避免图表快捷键响应。
            // Escape 在此处直接消费，不需要再继续传播。
            document.getElementById('floatEditorPanel').addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && fepOpen) { toggleFloatEditor(); return; }
                e.stopPropagation();
            });

            // Re-size CodeMirror on window resize when panel is open
            $(window).on('resize.fep', function() {
                if (fepOpen) fepResizeEditor();
            });

            //自定义函数和变量
            JSComplier.AddFunction({ Name:'FUNC_ALPHA', Description:'自定义Alpha函数', IsDownload:true, Invoke:(obj)=>{ return HQData.FUNC_ALPHA(obj); } } );
            JSComplier.AddVariant({ Name:'VAR_DEMO',   Description:'自定义变量1' } );


            hqKeyboard.Keyboard.Option.EventCallback=
            [
                {
                    event:JSCHART_EVENT_ID.ON_KEYBOARD_SELECTED,
                    callback:(event, data, obj)=>
                    {
                        console.log("[JSCHART_EVENT_ID.ON_KEYBOARD_SELECTED] data", data)
                        hqKeyboard.Hide();

                        if (!data || !data.RowData) return;

                        var selItem=data.RowData;
                        if (selItem.Data.Type===0)
                        {
                            klineControl.Chart.Focus();
                            klineControl.ChangeSymbol(selItem.Data.Symbol);
                            minuteControl.ChangeSymbol(selItem.Data.Symbol);
                        }
                        else if (selItem.Data.Type===1)
                        {
                            klineControl.Chart.Focus();
                            var windowIndex=0;
                            if (klineControl.Chart.JSChartContainer.GlobalOption.SelectedBorder)
                            {
                                var item=klineControl.Chart.JSChartContainer.GlobalOption.SelectedBorder;
                                if (item.Mode==1 && item.SelFrame>=0) windowIndex=item.SelFrame;
                            }
                            klineControl.Chart.ChangeIndex(windowIndex,selItem.Data.Index);
                        }
                        else if (selItem.Data.Type===2)
                        {
                            alert(`跳转'${selItem.Data.PageName}'页面`);
                        }
                    }
                },
            ]
            hqKeyboard.Inital();
            hqKeyboard.Create();
            HQData.Keyboard_RequestSymbolList(null, (data)=>{ hqKeyboard.SetSymbolData(data); });

            document.addEventListener('keydown', (event) =>
            {
                var div=document.getElementById('kline');
                if (div.contains(event.target) && event.target.tagName!="INPUT") //在K线上才出来键盘精灵
                {
                    hqKeyboard.OnGlobalKeydown(event)
                }
            });

            document.addEventListener("mousedown", (event)=>{ hqKeyboard.OnGlobalMouseDown(event) })
        })


    </script>

</body>
</html>


<style>

/* ================================================================
   CSS 变量 — TradingView 皮肤配色
   默认深色（未设置 tkchart_style 时等同于黑色皮肤）
   ================================================================ */
:root
{
    --BGColor:      #131722;
    --TabItemBG:    #1e222d;
    --BorderColor:  rgba(42,46,57,0.8);
    --TabTextColor: #d1d4dc;
}

/* 浅色皮肤 (tkchart_style="0") */
:root[tkchart_style='0'],
:root[tkchart_style='defined']
{
    --BGColor:      #ffffff;
    --TabItemBG:    #f0f3fa;
    --BorderColor:  #e0e3eb;
    --TabTextColor: #131722;
}

/* 深色皮肤 (tkchart_style="1") */
:root[tkchart_style='1']
{
    --BGColor:      #131722;
    --TabItemBG:    #1e222d;
    --BorderColor:  rgba(42,46,57,0.8);
    --TabTextColor: #d1d4dc;
}

html, body
{
    margin: 0;
    padding: 0;
}

body
{
    font-size: 14px;
    font-family: "Trebuchet MS", Arial, sans-serif;
    background-color: var(--BGColor);
}

/* 浏览器不会将 font-family 自动继承到表单元素，需显式覆盖 */
button, input, select, textarea
{
    font-family: "Trebuchet MS", Arial, sans-serif;
}

button
{
    font-size: 14px;
    letter-spacing: 0.5px;
}

select, input[type="text"], input[type="search"]
{
    font-size: 12px;
}

/* ================================================================
   彻底屏蔽所有悬浮提示窗口（动态生成，使用 !important 覆盖行内样式）
   ================================================================ */
.IYXChart_Tooltip_Name_Div,
[class*="IYXChart_Tooltip"],
[class*="IYXChart_Small_Tooltip"]
{
    display: none !important;
    visibility: hidden !important;
    width: 0 !important;
    height: 0 !important;
    opacity: 0 !important;
    pointer-events: none !important;
}

/* ================================================================
   顶部周期 Tab 栏
   ================================================================ */
#PeriodTab
{
    display: flex !important;
    align-items: center !important;
    width: 100%;
    height: 38px;
    padding: 0 5px;
    border-bottom: solid 1px var(--BorderColor);
    background-color: var(--BGColor);
    box-sizing: border-box;
    overflow: hidden;
}

/* ---- 图表容器 ---- */
#ChartContainer
{
    width: 100%;
    background-color: var(--BGColor);
    overflow: hidden;
}

#KLine
{
    width: 100%;
    height: 100%;
}

#kline
{
    width: 100%;
    position: relative;
    overflow: hidden;
}

#Minute
{
    width: 100%;
    height: 100%;
}

#MinuteCtrl
{
    width: 100%;
    position: relative;
    overflow: hidden;
}

/* ================================================================
   Tab 样式 — 废弃 float/line-height，改用 inline-flex 垂直居中
   ================================================================ */
.TabItem
{
    display: inline-flex;           /* 不加 !important，允许 JS 内联 style 隐藏元素 */
    align-items: center !important;
    justify-content: center !important;
    height: 100% !important;
    padding: 0 8px;
    line-height: 1 !important;
    border-right: solid 1px var(--BorderColor);
    cursor: pointer;
    background-color: var(--TabItemBG);
    color: var(--TabTextColor);
    font-size: 12px;
    font-family: "Trebuchet MS", Arial, sans-serif;
    white-space: nowrap;
    box-sizing: border-box;

    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

.TabItem:hover
{
    filter: brightness(1.15);
}

.TabItem.active
{
    color: rgb(54,162,231);
    border-bottom: 2px solid rgb(54,162,231);
}

.SpaceItem
{
    flex: 1;
}

/* ---- 皮肤切换图标按钮 ---- */
.ThemeSwitcherBtn
{
    border-right: none;
    padding: 0;
    transition: background-color 0.15s ease;
}

#ThemeBtn
{
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    width: 35px;
    height: 100%;
}

#LangBtn
{
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
    padding: 0 8px;
    min-width: 30px;
}

.ThemeSwitcherBtn svg
{
    display: block;
    flex-shrink: 0;
    width: 20px;
    height: 20px;
}

.ThemeSwitcherBtn:hover
{
    filter: none !important;
    background-color: rgba(128,128,128,0.2) !important;
    border-radius: 4px;
}

/* ================================================================
   搜索框 — 位于最左侧，右侧留 15px 间距后接周期 Tab
   ================================================================ */
.SearchInput
{
    height: 24px;
    padding: 0 6px;
    margin-left: 4px;
    border: 1px solid var(--BorderColor);
    background-color: var(--TabItemBG);
    color: var(--TabTextColor);
    font-size: 12px;
    width: 120px;
    box-sizing: border-box;
    outline: none;
    flex-shrink: 0;
}

.SearchInput:focus
{
    border-color: rgb(54,162,231);
}

.SearchClear
{
    padding: 0 4px;
    margin-right: 20px;   /* 搜索组右侧与第一个周期 Tab 的间距 */
    cursor: pointer;
    color: var(--TabTextColor);
    font-size: 14px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
}

.SearchClear:hover
{
    color: rgb(54,162,231);
}

/* ================================================================
   FLOAT EDITOR PANEL  (#floatEditorPanel)
   Pine Editor style — fixed right-side overlay
   ================================================================ */

#floatEditorPanel
{
    position: fixed;
    top: 38px;          /* below #PeriodTab */
    right: 0;
    width: 33.33%;      /* default 1/3 screen; JS resizer can override */
    min-width: 260px;
    max-width: 85vw;
    bottom: 0;
    z-index: 1000;
    display: none;      /* toggled to flex by JS */
    flex-direction: column;
    background: #131722;
    /* left border is now the resizer track; no static border-left here */
    font-family: "Trebuchet MS", Arial, sans-serif;
    color: #d1d4dc;
    overflow: hidden;
    box-sizing: border-box;
}

/* ── Left-edge drag handle ───────────────────────────────────── */
.fep-resizer
{
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: #434651;
    cursor: col-resize;
    z-index: 10;
    transition: background 0.15s;
    flex-shrink: 0;
}
.fep-resizer:hover,
.fep-resizer.dragging
{
    background: #2962ff;
}

/* ── Header ───────────────────────────────────────────────────── */
.fep-header
{
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 36px;
    padding: 0 12px;
    background: #1e222d;
    border-bottom: 1px solid #434651;
}

.fep-title
{
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    color: #787b86;
}

.fep-close
{
    width: 24px;
    height: 24px;
    border: none;
    background: transparent;
    color: #787b86;
    font-size: 14px;
    cursor: pointer;
    border-radius: 3px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.12s, color 0.12s;
}
.fep-close:hover { background: rgba(255,255,255,0.08); color: #d1d4dc; }

/* ── Top section — two columns ────────────────────────────────── */
.fep-top
{
    flex-shrink: 0;
    display: flex;
    border-bottom: 1px solid #434651;
}

/* Left: 4 control rows */
.fep-controls
{
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 5px 8px;
    gap: 4px;
    border-right: 1px solid #2a2e39;
    min-width: 0;
}

.fep-ctrl-row
{
    display: flex;
    align-items: center;
    gap: 5px;
    height: 28px;
}

.fep-input
{
    flex: 1;
    height: 24px;
    padding: 0 6px;
    background: #0b0e14;
    border: 1px solid #2a2e39;
    border-radius: 3px;
    color: #d1d4dc;
    font-size: 11px;
    font-family: inherit;
    outline: none;
    min-width: 0;
}
.fep-input:focus { border-color: #2962ff; }

.fep-select
{
    height: 24px;
    padding: 0 4px;
    background: #0b0e14;
    border: 1px solid #2a2e39;
    border-radius: 3px;
    color: #d1d4dc;
    font-size: 11px;
    font-family: inherit;
    outline: none;
    cursor: pointer;
    flex-shrink: 0;
}

.fep-btn
{
    height: 24px;
    padding: 0 8px;
    border-radius: 3px;
    border: 1px solid #2a2e39;
    background: #1e222d;
    color: #d1d4dc;
    font-size: 11px;
    font-family: inherit;
    cursor: pointer;
    white-space: nowrap;
    transition: background 0.1s, border-color 0.1s;
}
.fep-btn:hover { background: #2a2e39; border-color: #4c525e; }

.fep-btn-primary
{
    background: #2962ff;
    border-color: #2962ff;
    color: #fff;
    font-weight: 600;
}
.fep-btn-primary:hover { background: #1c4ed8; border-color: #1c4ed8; }

.fep-btn-save { color: #089981; border-color: rgba(8,153,129,0.4); }
.fep-btn-save:hover { background: rgba(8,153,129,0.15); border-color: #089981; }

.fep-check-lbl
{
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    color: #787b86;
    white-space: nowrap;
    cursor: pointer;
    -webkit-user-select: none;
    user-select: none;
}
.fep-check-lbl input { margin: 0; cursor: pointer; }

/* Active Editor button in period tab */
#btnOpenEditor.active { color: #2962ff; border-bottom: 2px solid #2962ff; }

/* Right: param rows */
.fep-params
{
    width: 160px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    padding: 5px 8px;
    gap: 4px;
}

.fep-param-row
{
    display: flex;
    align-items: center;
    gap: 4px;
    height: 26px;
    background: #0b0e14;
    border: 1px solid #2a2e39;
    border-radius: 3px;
    padding: 0 6px;
}

.fep-pname
{
    width: 34px;
    background: transparent;
    border: none;
    color: #787b86;
    font-size: 11px;
    font-family: inherit;
    outline: none;
}

.fep-peq { color: #434651; font-size: 11px; flex-shrink: 0; }

.fep-pval
{
    flex: 1;
    background: transparent;
    border: none;
    color: #d1d4dc;
    font-size: 11px;
    font-family: inherit;
    outline: none;
    text-align: right;
    -moz-appearance: textfield;
    appearance: textfield;
}
.fep-pval::-webkit-outer-spin-button,
.fep-pval::-webkit-inner-spin-button { -webkit-appearance: none; }

/* ── Middle section — flex:1, fills remaining height ─────────── */
.fep-middle
{
    flex: 1;
    display: flex;
    overflow: hidden;
}

/* Left: CodeMirror column */
.fep-editor-col
{
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border-right: 1px solid #434651;
    position: relative;
}

/* Right: status / list column */
.fep-status-col
{
    width: 200px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* ── Right-column tab bar ─────────────────────────────────────── */
.fep-tab-bar
{
    flex-shrink: 0;
    display: flex;
    background: #1e222d;
    border-bottom: 1px solid #434651;
}

.fep-tab
{
    flex: 1;
    height: 28px;
    padding: 0 3px;
    border: none;
    border-bottom: 2px solid transparent;
    background: transparent;
    color: #787b86;
    font-size: 10px;
    font-family: inherit;
    cursor: pointer;
    white-space: nowrap;
    transition: color 0.1s, border-color 0.1s;
}
.fep-tab:hover { color: #d1d4dc; }
.fep-tab.active { color: #d1d4dc; border-bottom-color: #2962ff; }

/* ── Tab content panels ───────────────────────────────────────── */
.fep-tab-content
{
    flex: 1;
    overflow: hidden;
    position: relative;
}

.fep-tab-panel
{
    position: absolute;
    inset: 0;
    overflow-y: auto;
}

/* Saved indicator list */
#fep-panel-list #local_index
{
    list-style: none;
    margin: 0;
    padding: 0;
}

#fep-panel-list #local_index li
{
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 5px 10px;
    font-size: 11px;
    color: #d1d4dc;
    cursor: pointer;
    border-bottom: 1px solid #1e222d;
}
#fep-panel-list #local_index li:hover { background: #1e222d; }

#fep-panel-list #local_index li span
{
    color: #f23645;
    font-size: 12px;
    cursor: pointer;
    padding: 0 3px;
    flex-shrink: 0;
}

/* Test result */
#fep-test-output
{
    margin: 0;
    padding: 8px 10px;
    font-size: 11px;
    font-family: "Trebuchet MS", Consolas, monospace;
    color: #d1d4dc;
    white-space: pre-wrap;
    word-break: break-all;
}
#fep-test-output.ok  { color: #089981; }   /* ✓ success — TV green  */
#fep-test-output.err { color: #f23645; }   /* ✗ error   — TV red    */

/* Dynamic translation output */
#fep-xlate-output
{
    margin: 0;
    padding: 8px 10px;
    font-size: 11px;
    font-family: "Trebuchet MS", Consolas, monospace;
    color: #B2B5BE;
    white-space: pre-wrap;
    word-break: break-all;
}

.fep-placeholder
{
    padding: 10px;
    font-size: 11px;
    color: #434651;
}

/* ── CodeMirror 编辑器结构样式 ────────────────────────────────── */
#floatEditorPanel .CodeMirror
{
    background: #0b0e14 !important;
    color: #d1d4dc !important;
    font-family: "Trebuchet MS", Consolas, monospace !important;
    font-size: 12px !important;
    height: 100% !important;
    border: none !important;
}

#floatEditorPanel .CodeMirror-scroll { overflow-y: auto !important; }

#floatEditorPanel .CodeMirror-gutters
{
    background: #131722 !important;
    border-right: 1px solid #2a2e39 !important;
}

#floatEditorPanel .CodeMirror-linenumber { color: #434651 !important; }
#floatEditorPanel .CodeMirror-cursor    { border-left-color: #d1d4dc !important; }

#floatEditorPanel .CodeMirror-selected,
#floatEditorPanel .CodeMirror-line ::selection
{
    background: rgba(41,98,255,0.25) !important;
}

/* ── IYX 公式 token 颜色 (theme: fep-dark) ──────────────────────
   对应 iyx-formula mode 返回的 token 类型
   CodeMirror 自动添加 cm- 前缀，e.g. 'builtin' → .cm-builtin
─────────────────────────────────────────────────────────────── */

/* 注释 { } 和 //                                                 */
#floatEditorPanel .cm-s-fep-dark .cm-comment   { color: #546e7a; font-style: italic; }
/* 字符串 '...'                                                   */
#floatEditorPanel .cm-s-fep-dark .cm-string    { color: #c3e88d; }
/* 数字字面量                                                     */
#floatEditorPanel .cm-s-fep-dark .cm-number    { color: #f78c6c; }
/* 运算符 / 标点                                                  */
#floatEditorPanel .cm-s-fep-dark .cm-operator  { color: #89ddff; }
/* 数据字段: CLOSE OPEN HIGH LOW VOL C O H L V ...               */
#floatEditorPanel .cm-s-fep-dark .cm-keyword   { color: #ff5370; font-weight: bold; }
/* 内置函数: MA EMA RSI DRAWTEXT IF CROSS ...                     */
#floatEditorPanel .cm-s-fep-dark .cm-builtin   { color: #82aaff; }
/* 用户定义变量: MA1 DIF2 VARHIGH ...                             */
#floatEditorPanel .cm-s-fep-dark .cm-variable  { color: #eeffff; }

/* ── 颜色常量 — 直接渲染为其对应的真实颜色 ──────────────────────
   颜色值来源: JSComplier.ColorVarToRGB (iyxchart.complier.js)
   示例: ,COLORYELLOW 在编辑器中显示为亮黄色
─────────────────────────────────────────────────────────────── */
#floatEditorPanel .cm-s-fep-dark .cm-clr-black    { color: #888888; }            /* COLORBLACK   (暗背景调亮) */
#floatEditorPanel .cm-s-fep-dark .cm-clr-blue     { color: rgb(18,95,216);   }   /* COLORBLUE     */
#floatEditorPanel .cm-s-fep-dark .cm-clr-green    { color: rgb(25,158,0);    }   /* COLORGREEN    */
#floatEditorPanel .cm-s-fep-dark .cm-clr-cyan     { color: rgb(0,255,198);   }   /* COLORCYAN     */
#floatEditorPanel .cm-s-fep-dark .cm-clr-red      { color: rgb(238,21,21);   }   /* COLORRED      */
#floatEditorPanel .cm-s-fep-dark .cm-clr-magenta  { color: rgb(255,0,222);   }   /* COLORMAGENTA  */
#floatEditorPanel .cm-s-fep-dark .cm-clr-brown    { color: rgb(149,94,15);   }   /* COLORBROWN    */
#floatEditorPanel .cm-s-fep-dark .cm-clr-ligray   { color: rgb(218,218,218); }   /* COLORLIGRAY   */
#floatEditorPanel .cm-s-fep-dark .cm-clr-gray     { color: rgb(133,133,133); }   /* COLORGRAY     */
#floatEditorPanel .cm-s-fep-dark .cm-clr-liblue   { color: rgb(94,204,255);  }   /* COLORLIBLUE   */
#floatEditorPanel .cm-s-fep-dark .cm-clr-ligreen  { color: rgb(183,255,190); }   /* COLORLIGREEN  */
#floatEditorPanel .cm-s-fep-dark .cm-clr-licyan   { color: rgb(154,255,242); }   /* COLORLICYAN   */
#floatEditorPanel .cm-s-fep-dark .cm-clr-lired    { color: rgb(255,172,172); }   /* COLORLIRED    */
#floatEditorPanel .cm-s-fep-dark .cm-clr-limagenta{ color: rgb(255,145,241); }   /* COLORLIMAGENTA*/
#floatEditorPanel .cm-s-fep-dark .cm-clr-white    { color: rgb(210,210,210); }   /* COLORWHITE    (暗背景调暗) */
#floatEditorPanel .cm-s-fep-dark .cm-clr-yellow   { color: rgb(255,198,0);   }   /* COLORYELLOW   */

/* ── Thin dark scrollbars throughout the panel ────────────────── */
#floatEditorPanel ::-webkit-scrollbar           { width: 5px; height: 5px; }
#floatEditorPanel ::-webkit-scrollbar-track     { background: transparent; }
#floatEditorPanel ::-webkit-scrollbar-thumb     { background: #434651; border-radius: 3px; }
#floatEditorPanel ::-webkit-scrollbar-thumb:hover { background: #787b86; }

/* ---- 绘图工具浮层保证在图表上方 ---- */
.IYXChart_DrawTool_Dialog_Div
{
    z-index: 10000 !important;
}
</style>
